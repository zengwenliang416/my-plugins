# Codex 协作策略

## 核心理念

CodeX 是你的**协作伙伴**而非**代码生成器**，通过相互质疑、共同求真的过程达成统一、全面、精准的意见。

**关键原则**：
- 通往真理的唯一途径是不断争辩和批判性思考
- codex 帮助你**思考**，而不是替你思考
- codex 提供**原型**，你负责**产品**
- codex 进行**审查**，你保持**质疑**

## 触发条件

### 适用场景（复杂编码任务）
- 涉及多文件修改的功能实现
- 架构设计和重构任务
- 不确定实现方案，需要方案对比
- 代码完成后的独立审查

### 不适用场景
- 简单修改不需要 codex 介入
- 已有明确规范的重复性工作
- 单文件小改动

## 强制执行的 4 步协作流程

### 步骤 1：需求分析协同（必须执行）

**触发时机**：对用户需求形成初步分析后

**执行要求**：
1. 将用户需求和你的初始思路告知 codex
2. 要求 codex 完善需求分析和实施计划
3. 对比 codex 的分析与你的思路，识别差异和盲区

**调用模板**：
```bash
mcp__codex__codex(
  PROMPT="用户需求：[具体需求]\n\n我的初步分析：[你的思路]\n\n请完善需求分析，识别潜在风险，并提供实施计划建议。",
  cd="/path/to/project",
  sandbox="read-only",
  return_all_messages=true
)
```

**输出要求**：
- 需求理解的差异点
- 识别的潜在风险
- 实施计划建议
- 技术选型考量

---

### 步骤 2：代码原型索取（必须执行，强制只读）

**触发时机**：实施具体编码任务前

**强制要求**：
- ⚠️ **严禁 codex 对代码做任何真实修改**
- **必须使用** `sandbox="read-only"`
- 要求 codex **仅给出 unified diff patch**
- 获取原型后，你**只能以此为逻辑参考，必须重写**成企业生产级代码

**调用模板**：
```bash
mcp__codex__codex(
  PROMPT="任务：[具体编码任务]\n\n要求：\n1. 仅分析和设计，严禁修改代码\n2. 输出 unified diff patch 格式的原型\n3. 说明设计理由和关键考量\n\n上下文：[相关代码/需求]",
  cd="/path/to/project",
  sandbox="read-only",  # ✅ 必须只读
  SESSION_ID=previous_session_id,  # 继续会话
  return_all_messages=true
)
```

**重写流程**：
1. 理解 codex 原型的核心逻辑和设计意图
2. 识别可改进之处（命名、结构、错误处理等）
3. 按项目规范重新编写代码
4. 添加必要的中文注释和文档
5. 确保符合 SOLID、DRY、KISS 原则

---

### 步骤 3：批判性重写（贯穿始终）

**核心原则**：
- codex 只能给出参考，你**必须有自己的思考**
- 对 codex 的回答提出**质疑**
- 通过不断争辩找到通向真理的唯一途径

**实践要求**：
- 当 codex 建议与你的判断冲突时，明确提出反对意见
- 要求 codex 解释设计理由，并与你的方案对比
- 不盲从权威，追求技术方案的最优解

**质疑模板**：
```bash
mcp__codex__codex(
  PROMPT="我对你的方案有以下疑问：\n\n1. [疑问1]\n2. [疑问2]\n\n我的替代方案是：[你的方案]\n\n请对比分析两种方案的优劣。",
  cd="/path/to/project",
  sandbox="read-only",
  SESSION_ID=session_id,
  return_all_messages=true
)
```

---

### 步骤 4：代码审查确认（必须执行）

**触发时机**：完成切实编码行为后

**强制要求**：
- **立即**使用 codex review 代码改动
- 对比需求完成程度
- 识别潜在问题和改进空间

**调用模板**：
```bash
mcp__codex__codex(
  PROMPT="我已完成以下代码修改：\n[改动摘要或文件路径]\n\n原始需求：[需求描述]\n\n请审查：\n1. 代码质量和规范性\n2. 需求完成程度\n3. 潜在bug和边界情况\n4. 改进建议",
  cd="/path/to/project",
  sandbox="read-only",
  SESSION_ID=session_id,
  return_all_messages=true
)
```

**审查要点**：
- 代码质量和规范性
- 需求完成程度
- 潜在 bug 和边界情况
- 改进建议

---

## 工具参数说明

### 必选参数

| 参数 | 类型 | 说明 |
|-----|------|-----|
| `PROMPT` | string | 发送给 codex 的任务指令 |
| `cd` | Path | codex 执行任务的工作目录根路径 |

### 可选参数

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|-------|-----|
| `sandbox` | string | "read-only" | 沙箱策略（**强制使用 read-only**） |
| `SESSION_ID` | UUID | None | 继续之前的会话 |
| `return_all_messages` | boolean | False | 返回所有消息（推理、工具调用等） |
| `skip_git_repo_check` | boolean | False | 允许在非 Git 仓库运行 |
| `image` | List[Path] | None | 附加图片文件到初始提示词 |
| `model` | string | None | 指定使用的模型 |
| `yolo` | boolean | False | 无需审批运行所有命令（❌ 禁止使用） |
| `profile` | string | None | 从 `~/.codex/config.toml` 加载的配置 |

### sandbox 策略

| 值 | 说明 | 使用场景 |
|---|------|---------|
| `"read-only"` | 只读模式，最安全 | ✅ **所有原型获取必须使用** |
| `"workspace-write"` | 允许在工作区写入 | ❌ 禁止用于原型 |
| `"danger-full-access"` | 完全访问权限 | ❌ 禁止用于原型 |

---

## 返回值格式

### 成功时
```json
{
  "success": true,
  "SESSION_ID": "uuid-string",
  "agent_messages": "agent回复的文本内容",
  "all_messages": []  // 仅当 return_all_messages=True 时包含
}
```

### 失败时
```json
{
  "success": false,
  "error": "错误信息"
}
```

---

## 会话管理

| 操作 | 方法 |
|-----|------|
| 开启新对话 | 不传 `SESSION_ID` 参数（或传 `None`） |
| 继续对话 | 将之前返回的 `SESSION_ID` 作为参数传入 |
| 会话追踪 | 每次调用必须保存返回的 `SESSION_ID` |

**示例**：
```python
# 第一次调用 - 开启新会话
result1 = mcp__codex__codex(
  PROMPT="需求分析...",
  cd="/project",
  sandbox="read-only"
)
session_id = result1["SESSION_ID"]

# 第二次调用 - 继续会话
result2 = mcp__codex__codex(
  PROMPT="基于上面的分析，请给出代码原型...",
  cd="/project",
  sandbox="read-only",
  SESSION_ID=session_id  # 继续会话
)
```

---

## 典型协作流程图

```
┌─────────────────────────────────────────────┐
│ 1. 初步分析（你的思考）                      │
│    └─ 形成对需求的初步理解                   │
└─────────────┬───────────────────────────────┘
              ▼
┌─────────────────────────────────────────────┐
│ 2. 需求分析协同（codex + 你）                │
│    ├─ 发送需求和初步思路给 codex             │
│    ├─ 获取 codex 的分析和建议               │
│    └─ 对比差异，完善计划                     │
└─────────────┬───────────────────────────────┘
              ▼
┌─────────────────────────────────────────────┐
│ 3. 代码原型索取（codex read-only）           │
│    ├─ 请求 unified diff patch               │
│    ├─ 获取设计理由和关键考量                 │
│    └─ ⚠️ 严禁直接使用，仅作参考              │
└─────────────┬───────────────────────────────┘
              ▼
┌─────────────────────────────────────────────┐
│ 4. 批判性重写（你的企业级实现）              │
│    ├─ 理解原型核心逻辑                       │
│    ├─ 识别改进点                             │
│    ├─ 按项目规范重写                         │
│    └─ 添加中文注释和文档                     │
└─────────────┬───────────────────────────────┘
              ▼
┌─────────────────────────────────────────────┐
│ 5. 代码审查确认（codex + 你）                │
│    ├─ 提交改动给 codex 审查                  │
│    ├─ 获取审查反馈                           │
│    ├─ 质疑 + 争辩                            │
│    └─ 优化改进                               │
└─────────────────────────────────────────────┘
```

---

## 强制遵守规范

### 必须执行
| 规范 | 说明 |
|-----|------|
| 会话追踪 | 每次调用必须保存返回的 `SESSION_ID` |
| 路径验证 | `cd` 参数必须指向存在的目录 |
| 只读原则 | 步骤 2（代码原型）**必须**使用 `sandbox="read-only"` |
| 原型转化 | codex 原型仅供逻辑参考，必须重写成企业级代码 |
| 审查确认 | 编码完成后必须执行步骤 4 |

### 禁止事项
| 禁止行为 | 原因 |
|---------|------|
| ❌ 直接使用 codex 生成的代码而不重写 | 无法保证企业级质量 |
| ❌ 跳过步骤 2（代码原型）直接实施修改 | 缺少设计参考 |
| ❌ 跳过步骤 4（代码审查） | 无法发现潜在问题 |
| ❌ 盲目接受 codex 建议而不质疑 | 失去批判性思考 |
| ❌ 使用 `workspace-write` 或 `danger-full-access` | 违反只读原则 |
| ❌ 使用 `yolo=true` | 危险操作 |

---

## 最佳实践

### 设置建议
- 始终设置 `return_all_messages=True` 获取 codex 的推理过程
- 利用 `SESSION_ID` 进行多轮交互，逐步细化方案
- 始终检查返回值的 `success` 字段

### 协作时机
| 场景 | 是否使用 codex |
|-----|---------------|
| 复杂逻辑设计 | ✅ codex 提供原型参考 |
| 不确定实现方案 | ✅ codex 提供多方案对比 |
| 代码完成后 | ✅ codex 进行独立审查 |
| 简单修改 | ❌ 不需要 codex 介入 |
| 重复性工作 | ❌ 已有明确规范 |

### 质疑技巧
1. 明确指出与你判断冲突的点
2. 要求 codex 解释设计理由
3. 提出你的替代方案进行对比
4. 追问边界情况和异常处理
5. 验证是否符合项目既有模式

---

## 记录要求

每次 codex 调用后，必须记录到 `operations-log.md`：

```markdown
## [时间戳] Codex 协作

### 调用信息
- 阶段: <需求分析|原型索取|审查确认>
- SESSION_ID: <会话ID>
- sandbox: read-only

### 输入
<发送给 codex 的 PROMPT 摘要>

### 输出
<codex 返回的关键结论/原型摘要>

### 决策
<基于 codex 输出做出的决策>

### 质疑点
<对 codex 建议的质疑和讨论>
```
