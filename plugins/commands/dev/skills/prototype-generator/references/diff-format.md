# Unified Diff Format Reference

Unified Diff 格式规范和原型生成指南。

---

## 1. Unified Diff 格式

### 1.1 基本结构

```diff
--- a/path/to/file.ts
+++ b/path/to/file.ts
@@ -start,count +start,count @@ context
 unchanged line
-removed line
+added line
 unchanged line
```

### 1.2 组成部分

| 部分 | 格式 | 说明 |
|------|------|------|
| 原文件 | `--- a/path` | 变更前文件路径 |
| 新文件 | `+++ b/path` | 变更后文件路径 |
| 块头 | `@@ -s,c +s,c @@` | 行号和行数信息 |
| 上下文 | ` line` (空格开头) | 未变更的行 |
| 删除 | `-line` | 被删除的行 |
| 添加 | `+line` | 新增的行 |

### 1.3 块头详解

```
@@ -10,6 +10,8 @@ function example()
    ^  ^  ^  ^  ^--- 可选：函数/类上下文
    |  |  |  +------ 新文件：从第10行开始，共8行
    |  |  +--------- 新文件行号起始
    |  +------------ 原文件：从第10行开始，共6行
    +--------------- 原文件行号起始
```

---

## 2. 新建文件

### 2.1 格式

```diff
--- /dev/null
+++ b/path/to/new-file.ts
@@ -0,0 +1,10 @@
+// New file content
+export function newFunction() {
+  return 'hello';
+}
```

### 2.2 说明

- 原文件使用 `/dev/null` 表示不存在
- 块头 `-0,0` 表示原文件无内容
- 所有行都是 `+` 开头

---

## 3. 删除文件

### 3.1 格式

```diff
--- a/path/to/deleted-file.ts
+++ /dev/null
@@ -1,10 +0,0 @@
-// Deleted file content
-export function oldFunction() {
-  return 'goodbye';
-}
```

### 3.2 说明

- 新文件使用 `/dev/null` 表示删除
- 块头 `+0,0` 表示新文件无内容
- 所有行都是 `-` 开头

---

## 4. 重命名文件

### 4.1 格式

```diff
--- a/old-path/file.ts
+++ b/new-path/file.ts
@@ -1,5 +1,5 @@
 // File content unchanged
 export function example() {
   return 'same';
 }
```

### 4.2 带内容修改的重命名

```diff
--- a/old-path/file.ts
+++ b/new-path/file.ts
@@ -1,5 +1,6 @@
 // File content
 export function example() {
-  return 'old';
+  return 'new';
+  // Added comment
 }
```

---

## 5. 原型生成规范

### 5.1 输出文件结构

```
${run_dir}/
└── prototype-{model}.diff
```

### 5.2 Diff 内容规范

```diff
# Prototype generated by {model}
# Task: {task_description}
# Generated at: {timestamp}

--- a/src/services/auth.ts
+++ b/src/services/auth.ts
@@ -10,6 +10,15 @@ export class AuthService {
   constructor(private config: AuthConfig) {}

+  /**
+   * Refresh JWT token
+   * @param refreshToken - Current refresh token
+   * @returns New access token
+   */
+  async refreshToken(refreshToken: string): Promise<string> {
+    // Implementation
+    return newToken;
+  }
+
   async login(credentials: Credentials): Promise<Token> {
     // existing code
   }
```

### 5.3 多文件 Diff

```diff
--- a/src/services/auth.ts
+++ b/src/services/auth.ts
@@ -10,6 +10,10 @@
 // changes...

--- a/src/types/auth.ts
+++ b/src/types/auth.ts
@@ -5,3 +5,8 @@
 // changes...

--- /dev/null
+++ b/src/utils/token.ts
@@ -0,0 +1,20 @@
+// new file...
```

---

## 6. 生成质量检查

### 6.1 Diff 验证规则

| 检查项 | 规则 |
|--------|------|
| 路径格式 | 必须以 `a/` 或 `b/` 开头 |
| 块头完整 | 必须包含行号信息 |
| 上下文行 | 至少 3 行（可配置） |
| 行前缀 | 必须是 ` `, `-`, `+` 之一 |

### 6.2 常见错误

```diff
# 错误：缺少 a/ b/ 前缀
--- src/file.ts  ❌
+++ src/file.ts  ❌

# 正确：
--- a/src/file.ts  ✅
+++ b/src/file.ts  ✅

# 错误：上下文行缺少空格前缀
context line  ❌

# 正确：
 context line  ✅
```

---

## 7. 应用 Diff

### 7.1 使用 git apply

```bash
# 检查 diff 是否可应用
git apply --check prototype.diff

# 应用 diff
git apply prototype.diff

# 应用并显示统计
git apply --stat prototype.diff
```

### 7.2 处理冲突

```bash
# 尝试 3-way merge
git apply --3way prototype.diff

# 反向应用（撤销）
git apply -R prototype.diff
```

---

## 8. 模型特定指南

### 8.1 Codex 原型

**擅长**:
- 复杂业务逻辑
- 数据库操作
- API 实现
- 错误处理

**Prompt 模板**:
```
基于分析方案，生成 Unified Diff 格式的代码原型。

要求：
1. 输出标准 Unified Diff 格式
2. 包含必要的类型定义
3. 添加错误处理
4. 包含基本的 JSDoc 注释

分析方案：
${analysis-codex.md}
```

### 8.2 Gemini 原型

**擅长**:
- React/Vue 组件
- CSS/Tailwind 样式
- 交互逻辑
- 响应式设计

**Prompt 模板**:
```
基于分析方案，生成 Unified Diff 格式的 UI 代码原型。

要求：
1. 输出标准 Unified Diff 格式
2. 使用 Tailwind CSS
3. 考虑响应式设计
4. 添加基本的可访问性属性

分析方案：
${analysis-gemini.md}
```

---

## 9. 返回值格式

```json
{
  "status": "success",
  "output_file": "${run_dir}/prototype-codex.diff",
  "model": "codex",
  "stats": {
    "files_changed": 3,
    "insertions": 150,
    "deletions": 20
  },
  "files": [
    "src/services/auth.ts",
    "src/types/auth.ts",
    "src/utils/token.ts"
  ]
}
```
