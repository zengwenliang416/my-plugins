---
name: impact-analyzer
description: |
  ã€è§¦å‘æ¡ä»¶ã€‘é‡æ„å·¥ä½œæµç¬¬ä¸‰æ­¥ï¼šåˆ†æé‡æ„å»ºè®®çš„å½±å“èŒƒå›´ã€‚
  ã€æ ¸å¿ƒäº§å‡ºã€‘è¾“å‡º ${run_dir}/impact-analysis.mdã€‚
  ã€ä¸è§¦å‘ã€‘æ£€æµ‹æ°”å‘³ï¼ˆç”¨ smell-detectorï¼‰ã€æ‰§è¡Œé‡æ„ï¼ˆç”¨ refactor-executorï¼‰ã€‚
  ã€å…ˆé—®ä»€ä¹ˆã€‘suggestions.json ä¸å­˜åœ¨æ—¶ï¼Œè¯¢é—®æ˜¯å¦å…ˆæ‰§è¡Œå»ºè®®ç”Ÿæˆ
  ã€MUSTã€‘LSP.findReferences è¿½è¸ªå¼•ç”¨ï¼Œå¿…é¡»ä½¿ç”¨ã€‚
allowed-tools:
  - Write
  - Read
  - LSP
  - Glob
  - mcp__auggie-mcp__codebase-retrieval
  - mcp__sequential-thinking__sequentialthinking
arguments:
  - name: run_dir
    type: string
    required: true
    description: è¿è¡Œç›®å½•è·¯å¾„ï¼ˆç”± command ä¼ å…¥ï¼‰
---

# Impact Analyzer - å½±å“èŒƒå›´åˆ†æåŸå­æŠ€èƒ½

## ğŸš¨ CRITICAL: MUST USE TOOLS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š å¼•ç”¨è¿½è¸ª                                                     â”‚
â”‚     âœ… å¿…é¡»ä½¿ç”¨: LSP.findReferences è¿½è¸ªæ¯ä¸ªé‡æ„ç›®æ ‡             â”‚
â”‚     âŒ ç¦æ­¢: çŒœæµ‹å½±å“èŒƒå›´                                        â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“‹ æµ‹è¯•è¦†ç›–                                                     â”‚
â”‚     âœ… åˆ†æç›®æ ‡ç¬¦å·æ˜¯å¦æœ‰æµ‹è¯•è¦†ç›–                                â”‚
â”‚     âœ… è¯†åˆ«éœ€è¦æ›´æ–°çš„æµ‹è¯•æ–‡ä»¶                                    â”‚
â”‚                                                                  â”‚
â”‚  âš ï¸  å¿…é¡»å¯¹æ¯ä¸ªé‡æ„ç›®æ ‡è°ƒç”¨ LSP.findReferencesï¼                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## MCP å·¥å…·é›†æˆ

| MCP å·¥å…·              | ç”¨é€”                         | è§¦å‘æ¡ä»¶        |
| --------------------- | ---------------------------- | --------------- |
| `sequential-thinking` | ç»“æ„åŒ–å½±å“è¯„ä¼°ï¼Œç¡®ä¿åˆ†æå®Œæ•´ | ğŸš¨ æ¯æ¬¡æ‰§è¡Œå¿…ç”¨ |
| `auggie-mcp`          | åˆ†ææ¨¡å—ä¾èµ–å…³ç³»å’Œæ¶æ„å½±å“   | ğŸš¨ å¿…é¡»ä½¿ç”¨     |

## å‰ç½®æ£€æŸ¥

1. éªŒè¯ `${run_dir}/suggestions.json` å­˜åœ¨
2. å¦‚æœä¸å­˜åœ¨ï¼Œæç¤ºç”¨æˆ·å…ˆæ‰§è¡Œ refactor-suggester

## æ‰§è¡Œæµç¨‹

### Step 0: ç»“æ„åŒ–å½±å“è¯„ä¼°è§„åˆ’ï¼ˆsequential-thinkingï¼‰

ğŸš¨ **å¿…é¡»é¦–å…ˆä½¿ç”¨ sequential-thinking è§„åˆ’è¯„ä¼°ç­–ç•¥**

```
mcp__sequential-thinking__sequentialthinking({
  thought: "è§„åˆ’å½±å“èŒƒå›´åˆ†æç­–ç•¥ã€‚éœ€è¦ï¼š1) è§£æé‡æ„å»ºè®® 2) è¿½è¸ªç¬¦å·å¼•ç”¨ 3) åˆ†ææµ‹è¯•è¦†ç›– 4) è¯„ä¼°é£é™©ç­‰çº§ 5) ç”Ÿæˆå½±å“æŠ¥å‘Š",
  thoughtNumber: 1,
  totalThoughts: 5,
  nextThoughtNeeded: true
})
```

### Step 1: è¯»å–é‡æ„å»ºè®®

```bash
suggestions=$(cat "${run_dir}/suggestions.json")
```

è§£ææ¯ä¸ªå»ºè®®çš„ï¼š

- é‡æ„ç±»å‹
- ç›®æ ‡æ–‡ä»¶
- ç›®æ ‡ç¬¦å·
- æ¶‰åŠçš„è¡ŒèŒƒå›´

### Step 2: LSP å¼•ç”¨è¿½è¸ªï¼ˆğŸš¨ MUST EXECUTEï¼‰

**å¯¹æ¯ä¸ªé‡æ„ç›®æ ‡ç¬¦å·å¿…é¡»è°ƒç”¨ LSP.findReferencesï¼š**

```
# 1. è·å–ç¬¦å·å®šä¹‰ä½ç½®
LSP(operation="goToDefinition", filePath="<file>", line=<line>, character=<char>)

# 2. æŸ¥æ‰¾æ‰€æœ‰å¼•ç”¨
LSP(operation="findReferences", filePath="<file>", line=<line>, character=<char>)

# 3. åˆ†æè°ƒç”¨å±‚æ¬¡ï¼ˆå¯é€‰ï¼Œç”¨äºå¤æ‚é‡æ„ï¼‰
LSP(operation="incomingCalls", filePath="<file>", line=<line>, character=<char>)
```

**äº§å‡º**ï¼š

- å¼•ç”¨ä½ç½®åˆ—è¡¨
- å—å½±å“çš„æ–‡ä»¶åˆ—è¡¨
- è°ƒç”¨é“¾æ·±åº¦

### Step 3: æ¨¡å—ä¾èµ–åˆ†æï¼ˆauggie-mcpï¼‰

ğŸš¨ **å¿…é¡»æ‰§è¡Œ**

```
mcp__auggie-mcp__codebase-retrieval({
  "information_request": "åˆ†æä»¥ä¸‹é‡æ„çš„æ¶æ„å½±å“ï¼š
    - é‡æ„ç›®æ ‡: ${target_symbol}
    - é‡æ„ç±»å‹: ${refactoring_type}

    è¯·åˆ†æï¼š
    1. è¯¥ç¬¦å·æ‰€å±çš„æ¨¡å—/å±‚çº§
    2. ä¾èµ–è¯¥æ¨¡å—çš„ä¸Šæ¸¸æ¨¡å—
    3. è¯¥æ¨¡å—ä¾èµ–çš„ä¸‹æ¸¸æ¨¡å—
    4. æ˜¯å¦æ¶‰åŠå…¬å…± API
    5. æ˜¯å¦æ¶‰åŠè·¨æ¨¡å—æ¥å£"
})
```

### Step 4: æµ‹è¯•è¦†ç›–åˆ†æ

**æŸ¥æ‰¾ç›¸å…³æµ‹è¯•æ–‡ä»¶ï¼š**

```bash
# æŸ¥æ‰¾æµ‹è¯•æ–‡ä»¶
find . -type f \( -name "*.test.ts" -o -name "*.spec.ts" -o -name "*_test.py" -o -name "*_test.go" \) | head -50
```

**ä½¿ç”¨ LSP æ£€æŸ¥æµ‹è¯•è¦†ç›–ï¼š**

å¯¹æ¯ä¸ªé‡æ„ç›®æ ‡ï¼Œæœç´¢æ˜¯å¦æœ‰æµ‹è¯•æ–‡ä»¶å¼•ç”¨è¯¥ç¬¦å·ï¼š

```
# åœ¨æµ‹è¯•ç›®å½•ä¸­æœç´¢ç¬¦å·
Grep(pattern="${symbol_name}", path="tests/", type="ts")
```

### Step 5: é£é™©è¯„ä¼°

**é£é™©ç­‰çº§åˆ¤å®šè§„åˆ™ï¼š**

| é£é™©ç­‰çº§    | åˆ¤å®šæ¡ä»¶                                   |
| ----------- | ------------------------------------------ |
| ğŸŸ¢ low      | å¼•ç”¨æ•° â‰¤ 5ï¼Œæ— å…¬å…± APIï¼Œæœ‰æµ‹è¯•è¦†ç›–         |
| ğŸŸ¡ medium   | å¼•ç”¨æ•° 6-20ï¼Œéå…¬å…± APIï¼Œéƒ¨åˆ†æµ‹è¯•è¦†ç›–      |
| ğŸ”¶ high     | å¼•ç”¨æ•° 21-50ï¼Œæˆ–æ¶‰åŠå…¬å…± APIï¼Œæˆ–æ— æµ‹è¯•è¦†ç›– |
| ğŸ”´ critical | å¼•ç”¨æ•° > 50ï¼Œæˆ–æ¶‰åŠæ ¸å¿ƒæ¨¡å—ï¼Œæˆ–è·¨å¤šä¸ªæ¨¡å—  |

**ç»¼åˆé£é™©å› ç´ ï¼š**

1. **å¼•ç”¨æ•°é‡**ï¼šå¼•ç”¨è¶Šå¤šï¼Œé£é™©è¶Šé«˜
2. **è°ƒç”¨é“¾æ·±åº¦**ï¼šè°ƒç”¨é“¾è¶Šæ·±ï¼Œé£é™©è¶Šé«˜
3. **æµ‹è¯•è¦†ç›–**ï¼šæ— æµ‹è¯•è¦†ç›–ï¼Œé£é™©å‡ä¸€çº§
4. **å…¬å…± API**ï¼šæ¶‰åŠå…¬å…± APIï¼Œé£é™©å‡ä¸€çº§
5. **è·¨æ¨¡å—**ï¼šæ¶‰åŠå¤šä¸ªæ¨¡å—ï¼Œé£é™©å‡ä¸€çº§

### Step 6: ç”Ÿæˆå½±å“åˆ†ææŠ¥å‘Š

**å†™å…¥ `${run_dir}/impact-analysis.md`**ï¼š

```markdown
# é‡æ„å½±å“åˆ†ææŠ¥å‘Š

## åˆ†ææ¦‚è§ˆ

| æŒ‡æ ‡         | å€¼                      |
| ------------ | ----------------------- |
| åˆ†ææ—¶é—´     | ${timestamp}            |
| é‡æ„å»ºè®®æ•°   | ${total_suggestions}    |
| å—å½±å“æ–‡ä»¶æ•° | ${affected_files_count} |
| æ€»å¼•ç”¨æ•°     | ${total_references}     |
| å¹³å‡é£é™©ç­‰çº§ | ${average_risk}         |

## é£é™©åˆ†å¸ƒ

| é£é™©ç­‰çº§    | æ•°é‡ | å æ¯” |
| ----------- | ---- | ---- |
| ğŸŸ¢ Low      | X    | X%   |
| ğŸŸ¡ Medium   | Y    | Y%   |
| ğŸ”¶ High     | Z    | Z%   |
| ğŸ”´ Critical | W    | W%   |

---

## è¯¦ç»†å½±å“åˆ†æ

### REF-001: Extract Method - processUserData

**é‡æ„ç›®æ ‡**: `src/services/UserService.ts:45` â†’ `processUserData`

**é£é™©ç­‰çº§**: ğŸŸ¢ Low

**å¼•ç”¨è¿½è¸ª**:

| æ–‡ä»¶                        | è¡Œå· | å¼•ç”¨ç±»å‹ |
| --------------------------- | ---- | -------- |
| src/services/UserService.ts | 45   | å®šä¹‰     |
| src/controllers/UserCtrl.ts | 23   | æ–¹æ³•è°ƒç”¨ |
| src/controllers/UserCtrl.ts | 67   | æ–¹æ³•è°ƒç”¨ |
| tests/UserService.test.ts   | 15   | æµ‹è¯•è°ƒç”¨ |

**å—å½±å“æ–‡ä»¶**: 3 ä¸ª

**è°ƒç”¨é“¾**:
```

UserController.handleRequest()
â””â”€â”€ UserService.processUserData() â† é‡æ„ç›®æ ‡
â”œâ”€â”€ validateUserInput()
â”œâ”€â”€ transformUserData()
â””â”€â”€ persistUserData()

```

**æµ‹è¯•è¦†ç›–**:
- âœ… å·²æœ‰æµ‹è¯•: `tests/UserService.test.ts`
- âš ï¸ éœ€è¦æ›´æ–°: æ·»åŠ æ–°æå–æ–¹æ³•çš„å•å…ƒæµ‹è¯•

**å»ºè®®**:
- å¯ä»¥å®‰å…¨æ‰§è¡Œ
- æ‰§è¡Œåéœ€è¦æ·»åŠ  3 ä¸ªæ–°æ–¹æ³•çš„å•å…ƒæµ‹è¯•

---

### REF-002: Extract Class - AppManager

**é‡æ„ç›®æ ‡**: `src/core/AppManager.ts:1` â†’ `AppManager`

**é£é™©ç­‰çº§**: ğŸ”´ Critical

**å¼•ç”¨è¿½è¸ª**:

| æ–‡ä»¶                          | è¡Œå· | å¼•ç”¨ç±»å‹   |
| ----------------------------- | ---- | ---------- |
| src/core/AppManager.ts        | 1    | å®šä¹‰       |
| src/index.ts                  | 5    | å¯¼å…¥       |
| src/services/*.ts             | å¤šå¤„ | æ–¹æ³•è°ƒç”¨   |
| ... (å…± 45 å¤„å¼•ç”¨)            |      |            |

**å—å½±å“æ–‡ä»¶**: 15 ä¸ª

**è°ƒç”¨é“¾**:
```

index.ts
â””â”€â”€ AppManager â† é‡æ„ç›®æ ‡
â”œâ”€â”€ ConfigManager (å¾…æå–)
â”œâ”€â”€ StateManager (å¾…æå–)
â””â”€â”€ EventBus (å¾…æå–)

```

**æµ‹è¯•è¦†ç›–**:
- âš ï¸ éƒ¨åˆ†è¦†ç›–: `tests/AppManager.test.ts`
- âŒ é›†æˆæµ‹è¯•: `tests/integration/*.test.ts` å¯èƒ½å—å½±å“

**å»ºè®®**:
- âš ï¸ é«˜é£é™©é‡æ„ï¼Œå»ºè®®äº¤äº’å¼æ‰§è¡Œ
- éœ€è¦æ›´æ–° 15 ä¸ªæ–‡ä»¶çš„å¯¼å…¥è¯­å¥
- å»ºè®®åˆ†æ­¥éª¤æ‰§è¡Œï¼š
  1. å…ˆæå– ConfigManager
  2. éªŒè¯æµ‹è¯•é€šè¿‡
  3. å†æå– StateManager
  4. éªŒè¯æµ‹è¯•é€šè¿‡
  5. æœ€åæå– EventBus

---

## æ‰§è¡Œå»ºè®®

### ğŸŸ¢ å¯è‡ªåŠ¨æ‰§è¡Œï¼ˆä½é£é™©ï¼‰

| ID      | é‡æ„ç±»å‹       | ç›®æ ‡           | å¼•ç”¨æ•° |
| ------- | -------------- | -------------- | ------ |
| REF-001 | Extract Method | processUserData| 4      |
| REF-003 | Rename         | helper â†’ utils | 3      |

### ğŸŸ¡ å»ºè®®äº¤äº’æ‰§è¡Œï¼ˆä¸­é£é™©ï¼‰

| ID      | é‡æ„ç±»å‹       | ç›®æ ‡           | å¼•ç”¨æ•° |
| ------- | -------------- | -------------- | ------ |
| REF-004 | Move Method    | fetchData      | 12     |

### ğŸ”´ éœ€è¦ç¡®è®¤ï¼ˆé«˜/æé«˜é£é™©ï¼‰

| ID      | é‡æ„ç±»å‹       | ç›®æ ‡           | å¼•ç”¨æ•° | é£é™©åŸå›           |
| ------- | -------------- | -------------- | ------ | ----------------- |
| REF-002 | Extract Class  | AppManager     | 45     | æ ¸å¿ƒæ¨¡å—ï¼Œè·¨æ¨¡å—   |
| REF-005 | Introduce Interface | DataService | 28   | æ¶‰åŠå…¬å…± API      |

---

## æµ‹è¯•å½±å“æ‘˜è¦

| æµ‹è¯•æ–‡ä»¶                    | å½±å“ç¨‹åº¦ | éœ€è¦æ“ä½œ             |
| --------------------------- | -------- | -------------------- |
| tests/UserService.test.ts   | ä½       | æ·»åŠ æ–°æ–¹æ³•æµ‹è¯•       |
| tests/AppManager.test.ts    | é«˜       | å¤§é‡æ›´æ–°             |
| tests/integration/*.test.ts | ä¸­       | æ›´æ–°å¯¼å…¥å’Œæ–­è¨€       |

---

## æ£€æµ‹æ–¹æ³•éªŒè¯

- [x] LSP.findReferences è¿½è¸ªå¼•ç”¨
- [x] LSP.incomingCalls åˆ†æè°ƒç”¨é“¾
- [x] auggie-mcp åˆ†ææ¨¡å—ä¾èµ–
- [x] æµ‹è¯•è¦†ç›–åˆ†æ

---

åˆ†ææ—¶é—´: ${timestamp}
ä¸‹ä¸€æ­¥: ç¡®è®¤åè°ƒç”¨ refactor-executor æ‰§è¡Œé‡æ„
```

---

## è´¨é‡é—¨æ§

### å·¥å…·ä½¿ç”¨éªŒè¯

- [ ] å¯¹æ¯ä¸ªé‡æ„ç›®æ ‡è°ƒç”¨äº† `LSP.findReferences`
- [ ] è°ƒç”¨äº† `mcp__auggie-mcp__codebase-retrieval` åˆ†æä¾èµ–
- [ ] ç”Ÿæˆäº† `impact-analysis.md`

### äº§å‡ºè´¨é‡éªŒè¯

- [ ] æ¯ä¸ªå»ºè®®æœ‰å¼•ç”¨è¿½è¸ªç»“æœ
- [ ] æ¯ä¸ªå»ºè®®æœ‰é£é™©è¯„ä¼°
- [ ] æ¯ä¸ªå»ºè®®æœ‰æµ‹è¯•è¦†ç›–åˆ†æ
- [ ] æœ‰æ˜ç¡®çš„æ‰§è¡Œå»ºè®®

---

## çº¦æŸ

- ä¸æ£€æµ‹ä»£ç æ°”å‘³ï¼ˆäº¤ç»™ smell-detectorï¼‰
- ä¸ç”Ÿæˆé‡æ„å»ºè®®ï¼ˆäº¤ç»™ refactor-suggesterï¼‰
- ä¸æ‰§è¡Œé‡æ„ï¼ˆäº¤ç»™ refactor-executorï¼‰
- **å¿…é¡»ä½¿ç”¨ LSP.findReferences è¿½è¸ªå¼•ç”¨ï¼Œä¸èƒ½çŒœæµ‹å½±å“èŒƒå›´**
