# Risk Assessment Guidelines - 风险评估指南

## 风险等级定义

| 等级     | 标识 | 条件                                       | 建议操作       |
| -------- | ---- | ------------------------------------------ | -------------- |
| Low      | 🟢   | 引用数 ≤ 5，非公共 API，有测试覆盖         | 可自动执行     |
| Medium   | 🟡   | 引用数 6-20，非公共 API，部分测试覆盖      | 建议交互执行   |
| High     | 🔶   | 引用数 21-50，或涉及公共 API，或无测试覆盖 | 需要用户确认   |
| Critical | 🔴   | 引用数 > 50，或涉及核心模块，或跨多个模块  | 需详细方案评审 |

---

## 风险评估维度

### 1. 引用数量 (Reference Count)

**评估方法**: LSP.findReferences

| 引用数 | 风险加权 |
| ------ | -------- |
| 0-5    | +0       |
| 6-20   | +1       |
| 21-50  | +2       |
| 51+    | +3       |

### 2. 调用链深度 (Call Chain Depth)

**评估方法**: LSP.incomingCalls / LSP.outgoingCalls

| 深度 | 风险加权 |
| ---- | -------- |
| 1-2  | +0       |
| 3-5  | +1       |
| 6+   | +2       |

### 3. 测试覆盖 (Test Coverage)

**评估方法**: 搜索测试文件中的符号引用

| 覆盖状态 | 风险加权 |
| -------- | -------- |
| 完全覆盖 | -1       |
| 部分覆盖 | +0       |
| 无覆盖   | +2       |

### 4. 公共 API (Public API)

**评估方法**: 检查 export 状态和模块边界

| API 类型 | 风险加权 |
| -------- | -------- |
| 私有方法 | +0       |
| 包内公共 | +1       |
| 对外 API | +3       |

### 5. 跨模块影响 (Cross-Module Impact)

**评估方法**: auggie-mcp 模块依赖分析

| 影响范围 | 风险加权 |
| -------- | -------- |
| 单文件   | +0       |
| 单模块   | +1       |
| 跨模块   | +2       |
| 核心模块 | +3       |

---

## 风险计算公式

```
总风险分 = 引用分 + 调用链分 + 测试分 + API分 + 跨模块分

最终等级:
- 总分 ≤ 2  → 🟢 Low
- 总分 3-5  → 🟡 Medium
- 总分 6-8  → 🔶 High
- 总分 > 8  → 🔴 Critical
```

---

## 特殊风险因素

### 自动升级为 Critical 的情况

1. **数据库 Schema 变更** - 任何涉及数据库结构的修改
2. **安全相关代码** - 认证、授权、加密相关
3. **支付/交易逻辑** - 涉及金钱的核心逻辑
4. **并发控制代码** - 锁、事务、队列相关
5. **外部 API 接口** - 对外暴露的 API 签名变更

### 降级条件

1. **完善的测试覆盖** - 可降低一级风险
2. **Feature Flag 保护** - 可回滚时降低一级
3. **灰度发布能力** - 可渐进发布时降低一级

---

## 执行建议矩阵

| 风险等级    | auto 模式 | interactive 模式 | 建议       |
| ----------- | --------- | ---------------- | ---------- |
| 🟢 Low      | 自动执行  | 快速确认         | 可批量处理 |
| 🟡 Medium   | 自动执行  | 单独确认         | 正常流程   |
| 🔶 High     | 需确认    | 详细说明         | 需要测试   |
| 🔴 Critical | 拒绝自动  | 详细方案         | 需要评审   |

---

## LSP 调用要求

**每个重构目标必须执行的 LSP 操作**:

```
1. LSP.goToDefinition   → 确认定义位置
2. LSP.findReferences   → 获取所有引用
3. LSP.incomingCalls    → 分析谁调用它
4. LSP.outgoingCalls    → 分析它调用谁
5. LSP.hover            → 获取类型信息
```

**最少调用次数**: 每个重构目标 ≥ 3 次 LSP 操作

---

## 测试影响分析

### 测试文件识别规则

| 模式                     | 语言       |
| ------------------------ | ---------- |
| `*.test.ts`, `*.spec.ts` | TypeScript |
| `*.test.js`, `*.spec.js` | JavaScript |
| `*_test.py`              | Python     |
| `*_test.go`              | Go         |
| `*Test.java`             | Java       |

### 测试更新建议

| 重构类型       | 测试影响 | 建议                     |
| -------------- | -------- | ------------------------ |
| Extract Method | 新增测试 | 为提取的方法添加单元测试 |
| Extract Class  | 新增测试 | 为新类添加完整测试套件   |
| Rename         | 更新引用 | 更新测试中的符号引用     |
| Move           | 更新导入 | 更新测试中的导入路径     |
| Delete         | 删除测试 | 移除无效测试             |

---

## 参考资源

- Software Engineering at Google - Testing Chapter
- Martin Fowler - Refactoring Safety
- Michael Feathers - Working Effectively with Legacy Code
