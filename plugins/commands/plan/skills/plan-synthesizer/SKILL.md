---
name: plan-synthesizer
description: |
  【触发条件】plan 工作流第六步：整合所有产物生成最终计划
  【核心产出】输出 ${run_dir}/plan.md
  【硬停止】必须等待用户批准
allowed-tools:
  - Read
  - Write
arguments:
  - name: run_dir
    type: string
    required: true
    description: 运行目录路径（由 orchestrator 传入）
---

# Plan Synthesizer - 计划整合原子技能

## 职责边界

- **输入**: `run_dir` + 所有前置产物
- **输出**: `${run_dir}/plan.md`
- **单一职责**: 只做计划整合，不做新的分析

## 执行流程

### Step 1: 读取所有产物

```bash
INPUT=$(cat "${run_dir}/input.md")
REQUIREMENTS=$(cat "${run_dir}/requirements.md")
CONTEXT=$(cat "${run_dir}/context.md")
ARCHITECTURE=$(cat "${run_dir}/architecture.md")
TASKS=$(cat "${run_dir}/tasks.md")
RISKS=$(cat "${run_dir}/risks.md")
```

### Step 2: 提取摘要

从每个产物中提取关键信息：

| 产物            | 提取内容                     |
| --------------- | ---------------------------- |
| requirements.md | 核心需求、任务类型、验收标准 |
| context.md      | 关键文件、技术栈、依赖       |
| architecture.md | 架构决策、API 设计、组件结构 |
| tasks.md        | 任务数量、关键路径、里程碑   |
| risks.md        | 高风险、必要缓解措施         |

### Step 3: 生成计划 ID

```bash
RUN_ID=$(basename "${run_dir}")
# 格式: YYYYMMDDTHHMMSSZ
```

### Step 4: 计算预估

汇总任务复杂度：

| 复杂度 | 基准 | 任务数 | 小计 |
| ------ | ---- | ------ | ---- |
| 1/5    | -    | X      | -    |
| 2/5    | -    | Y      | -    |
| 3/5    | -    | Z      | -    |
| 4/5    | -    | W      | -    |
| 5/5    | -    | V      | -    |

### Step 5: 评估风险等级

| 条件           | 整体风险等级 |
| -------------- | ------------ |
| 有 HIGH 风险   | 高           |
| 有 MEDIUM 风险 | 中           |
| 仅 LOW 风险    | 低           |

### Step 6: 结构化输出

将整合结果写入 `${run_dir}/plan.md`：

```markdown
# 开发实施计划

## 元信息

| 属性     | 值                             |
| -------- | ------------------------------ |
| 规划 ID  | [RUN_ID]                       |
| 生成时间 | [timestamp]                    |
| 任务类型 | [frontend\|backend\|fullstack] |
| 总任务数 | [count]                        |
| 风险等级 | [低\|中\|高]                   |

---

## 执行摘要

### 需求概述

[从 requirements.md 提取的一段话描述]

### 技术方案

[从 architecture.md 提取的一段话描述]

### 关键风险

| 风险    | 等级   | 缓解措施 |
| ------- | ------ | -------- |
| [风险1] | HIGH   | [措施]   |
| [风险2] | MEDIUM | [措施]   |

---

## 需求规格

### 功能需求

| ID     | 需求描述 | 优先级 |
| ------ | -------- | ------ |
| FR-001 | [描述]   | P1     |
| FR-002 | [描述]   | P2     |

### 非功能需求

| ID      | 类别 | 约束描述          |
| ------- | ---- | ----------------- |
| NFR-001 | 性能 | API 响应 < 200ms  |
| NFR-002 | 安全 | OWASP Top 10 合规 |

### 验收标准

- [ ] [标准1]
- [ ] [标准2]
- [ ] [标准3]

---

## 架构设计

### 系统架构图
```

[ASCII 架构图或 Mermaid]

````

### 关键组件

| 组件 | 类型 | 职责 |
|-----|-----|-----|
| AuthService | 后端服务 | 认证逻辑 |
| LoginForm | 前端组件 | 登录界面 |

### 架构决策

| 决策 | 选择 | 理由 |
|-----|-----|-----|
| 认证方案 | JWT + OAuth2 | 行业标准 |
| 状态管理 | Zustand | 轻量级 |

---

## 实施路线图

### 阶段划分

```mermaid
gantt
    title 实施路线图
    dateFormat  YYYY-MM-DD
    section 阶段1
    基础设施       :a1, 2026-01-19, 1d
    section 阶段2
    后端 API       :a2, after a1, 1d
    section 阶段3
    前端开发       :a3, after a1, 2d
    section 阶段4
    集成联调       :a4, after a2 a3, 1d
````

### 关键路径

```
T-001 → T-002 → T-006 → T-011 → T-012
```

### 里程碑

| 里程碑           | 完成条件      | 验收标准         |
| ---------------- | ------------- | ---------------- |
| M1: 基础设施就绪 | T-001 ~ T-004 | 数据库可连接     |
| M2: API 可用     | T-005, T-006  | Swagger 可访问   |
| M3: 前端原型     | T-009, T-010  | Storybook 可演示 |
| M4: 功能完成     | 全部任务      | E2E 测试通过     |

### 任务清单

| 阶段 | ID    | 任务               | 类型    | 复杂度 | 依赖  |
| ---- | ----- | ------------------ | ------- | ------ | ----- |
| 1    | T-001 | 创建数据库迁移     | backend | 2/5    | -     |
| 1    | T-002 | 实现 Prisma Schema | backend | 2/5    | T-001 |
| ...  | ...   | ...                | ...     | ...    | ...   |

---

## 风险与缓解

### 风险登记表

| ID    | 风险       | 等级   | 缓解措施  | 状态   |
| ----- | ---------- | ------ | --------- | ------ |
| R-001 | 数据库迁移 | MEDIUM | 备份+回滚 | 待处理 |
| R-002 | JWT 泄露   | MEDIUM | 密钥轮换  | 待处理 |

### 必须处理（阻塞发布）

1. **R-001: 准备数据库迁移回滚方案**
   - 责任人: DBA
   - 验证: 回滚测试通过

2. **R-002: 实现 JWT secret 轮换机制**
   - 责任人: 后端开发
   - 验证: 密钥轮换测试

---

## 验证计划

### 测试策略

| 测试类型 | 工具       | 覆盖目标     |
| -------- | ---------- | ------------ |
| 单元测试 | Jest       | 核心逻辑 80% |
| 集成测试 | Supertest  | API 100%     |
| E2E 测试 | Playwright | 关键流程     |

### 质量门禁

- [ ] 单元测试通过
- [ ] 集成测试通过
- [ ] E2E 测试通过
- [ ] 代码审查通过
- [ ] 安全扫描无高危
- [ ] 性能测试达标

---

## 后续操作

### 批准此计划

确认以上计划后，执行开发：

```bash
/dev --plan-id=${RUN_ID}
```

### 产物清单

```
${run_dir}/
├── input.md           # 原始输入
├── requirements.md    # 需求规格
├── context.md         # 代码上下文
├── architecture.md    # 架构设计
├── tasks.md           # 任务分解
├── risks.md           # 风险评估
└── plan.md            # 本计划文档
```

---

**规划 ID**: `${RUN_ID}`
**生成时间**: [timestamp]
**状态**: 待批准

```

## 返回值

执行完成后，返回：

```

计划整合完成。
输出文件: ${run_dir}/plan.md
规划 ID: ${RUN_ID}
任务数: X 个
风险等级: [低|中|高]

⏸️ 等待用户批准...

批准后执行: /dev --plan-id=${RUN_ID}

```

## 质量门控

- ✅ 整合了所有前置产物
- ✅ 生成了执行摘要
- ✅ 包含了实施路线图
- ✅ 列出了验收标准
- ✅ 提供了后续操作指引

## 约束

- 不做新的分析，只整合已有产物
- 必须等待用户批准
- 计划文档必须可独立阅读
- 必须包含后续操作指引
```
