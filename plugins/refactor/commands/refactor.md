---
description: "é‡æ„å·¥ä½œæµï¼šä»£ç æ°”å‘³æ£€æµ‹ â†’ é‡æ„å»ºè®® â†’ å½±å“åˆ†æ â†’ å®‰å…¨æ‰§è¡Œ | é—ç•™ç³»ç»Ÿç°ä»£åŒ–"
argument-hint: <target-path> [--mode=analyze|auto|interactive] [--focus=smell|pattern|all] [--legacy] [--source-stack=xxx] [--target-stack=xxx] [--run-id=xxx]
allowed-tools:
  - Skill
  - AskUserQuestion
  - Read
  - LSP
---

# /refactor - é‡æ„å·¥ä½œæµå‘½ä»¤

## ä½¿ç”¨æ–¹å¼

### å¸¸è§„é‡æ„æ¨¡å¼

```bash
/refactor src/services/                      # åˆ†æé‡æ„æœºä¼š
/refactor src/utils/helper.ts --mode=auto    # è‡ªåŠ¨æ‰§è¡Œå®‰å…¨é‡æ„
/refactor --mode=interactive src/            # äº¤äº’å¼é€æ­¥é‡æ„
/refactor --focus=smell src/                 # ä»…æ£€æµ‹ä»£ç æ°”å‘³
/refactor --run-id=20260115T100000Z          # æ–­ç‚¹ç»­ä¼ 
```

### ğŸ†• é—ç•™ç³»ç»Ÿç°ä»£åŒ–æ¨¡å¼

```bash
# åŸºç¡€ç”¨æ³•ï¼šè‡ªåŠ¨æ£€æµ‹æŠ€æœ¯æ ˆ
/refactor --legacy .

# æŒ‡å®šæºæŠ€æœ¯æ ˆå’Œç›®æ ‡æŠ€æœ¯æ ˆ
/refactor --legacy --source-stack="jQuery + PHP + MySQL" --target-stack="React + Node.js + PostgreSQL" .

# å¸¸è§è¿ç§»åœºæ™¯
/refactor --legacy --source-stack="AngularJS 1.x" --target-stack="Angular 17" src/
/refactor --legacy --source-stack="Java EE + JSP" --target-stack="Spring Boot + React" .
/refactor --legacy --source-stack="COBOL + DB2" --target-stack="Java + PostgreSQL" .
```

## ğŸš¨ğŸš¨ğŸš¨ MUST FOLLOW RULES ğŸš¨ğŸš¨ğŸš¨

**ä½ å¿…é¡»æŒ‰ç…§ä¸‹é¢çš„ Phase é¡ºåºï¼Œä½¿ç”¨ Skill å·¥å…·è°ƒç”¨å¯¹åº”çš„ skillã€‚**

**ç¦æ­¢è¡Œä¸ºï¼ˆè¿ååˆ™å·¥ä½œæµå¤±è´¥ï¼‰ï¼š**

- âŒ è·³è¿‡ Skill è°ƒç”¨ï¼Œè‡ªå·±ç›´æ¥é‡æ„ä»£ç 
- âŒ ç”¨ Read/Write/Edit æ›¿ä»£ Skill è°ƒç”¨
- âŒ çœç•¥ä»»ä½• Phase
- âŒ æœªç»å½±å“åˆ†æå°±æ‰§è¡Œé‡æ„

**æ¯ä¸ª Phase ä½ å¿…é¡»ï¼š**

1. è°ƒç”¨æŒ‡å®šçš„ Skillï¼ˆä½¿ç”¨ Skill å·¥å…·ï¼‰
2. ç­‰å¾… Skill æ‰§è¡Œå®Œæˆ
3. éªŒè¯è¾“å‡ºæ–‡ä»¶å­˜åœ¨
4. å†è¿›å…¥ä¸‹ä¸€ä¸ª Phase

---

## Phase 1: åˆå§‹åŒ–

1. è§£æå‚æ•°ï¼š
   - MODE: analyze (é»˜è®¤) | auto | interactive
   - FOCUS: all (é»˜è®¤) | smell | pattern
   - TARGET: ç›®æ ‡è·¯å¾„ï¼ˆæ–‡ä»¶æˆ–ç›®å½•ï¼‰
   - **LEGACY**: false (é»˜è®¤) | trueï¼ˆå¯ç”¨é—ç•™ç³»ç»Ÿç°ä»£åŒ–æ¨¡å¼ï¼‰
   - **SOURCE_STACK**: æºæŠ€æœ¯æ ˆæè¿°ï¼ˆ--legacy æ¨¡å¼ä¸‹ä½¿ç”¨ï¼‰
   - **TARGET_STACK**: ç›®æ ‡æŠ€æœ¯æ ˆæè¿°ï¼ˆ--legacy æ¨¡å¼ä¸‹ä½¿ç”¨ï¼‰

2. ç”Ÿæˆè¿è¡Œç›®å½•è·¯å¾„ï¼š
   - RUN_ID: å½“å‰ UTC æ—¶é—´æˆ³ï¼Œæ ¼å¼ YYYYMMDDTHHMMSSZ
   - RUN_DIR: `openspec/changes/${RUN_ID}`

3. ä½¿ç”¨ AskUserQuestion ç¡®è®¤æ‰§è¡Œè®¡åˆ’

Spec-only policy: refactor artifacts MUST be consolidated under `openspec/changes/${RUN_ID}`.

**ğŸ†• å¦‚æœ LEGACY=trueï¼Œå±•ç¤ºé—ç•™ç³»ç»Ÿç°ä»£åŒ–è®¡åˆ’**:

```
ğŸ“‹ é—ç•™ç³»ç»Ÿç°ä»£åŒ–è®¡åˆ’:
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ #  â”‚ é˜¶æ®µ               â”‚ æ‰§è¡Œè€…           â”‚ æ¨¡å¼       â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚ é—ç•™ç³»ç»Ÿåˆ†æ       â”‚ legacy-analyzer  â”‚ åå°       â”‚
â”‚ 2  â”‚ ä»£ç æ°”å‘³æ£€æµ‹       â”‚ smell-detector   â”‚ åå°       â”‚
â”‚ 3  â”‚ è¿ç§»å»ºè®®ç”Ÿæˆ       â”‚ refactor-suggesterâ”‚ åå°      â”‚
â”‚ 4  â”‚ å½±å“èŒƒå›´åˆ†æ       â”‚ impact-analyzer  â”‚ åå°       â”‚
â”‚ 5  â”‚ ç”¨æˆ·ç¡®è®¤           â”‚ ç”¨æˆ·             â”‚ ç¡¬åœæ­¢     â”‚
â”‚ 6  â”‚ å®‰å…¨é‡æ„æ‰§è¡Œ       â”‚ refactor-executorâ”‚ åå°       â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç›®æ ‡: ${TARGET}
æ¨¡å¼: ${MODE}
æºæŠ€æœ¯æ ˆ: ${SOURCE_STACK}
ç›®æ ‡æŠ€æœ¯æ ˆ: ${TARGET_STACK}

ç¡®è®¤æ‰§è¡Œ? [Y/n]
```

**å¸¸è§„æ¨¡å¼æ‰§è¡Œè®¡åˆ’**:

```
ğŸ“‹ é‡æ„æ‰§è¡Œè®¡åˆ’:
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ #  â”‚ é˜¶æ®µ               â”‚ æ‰§è¡Œè€…       â”‚ æ¨¡å¼       â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚ ä»£ç æ°”å‘³æ£€æµ‹       â”‚ smell-detector â”‚ åå°     â”‚
â”‚ 2  â”‚ é‡æ„å»ºè®®ç”Ÿæˆ       â”‚ refactor-suggester â”‚ åå° â”‚
â”‚ 3  â”‚ å½±å“èŒƒå›´åˆ†æ       â”‚ impact-analyzer â”‚ åå°    â”‚
â”‚ 4  â”‚ ç”¨æˆ·ç¡®è®¤           â”‚ ç”¨æˆ·         â”‚ ç¡¬åœæ­¢     â”‚
â”‚ 5  â”‚ å®‰å…¨é‡æ„æ‰§è¡Œ       â”‚ refactor-executor â”‚ åå°  â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç›®æ ‡: ${TARGET}
æ¨¡å¼: ${MODE}

ç¡®è®¤æ‰§è¡Œ? [Y/n]
```

---

## Phase 1.5: é—ç•™ç³»ç»Ÿåˆ†æï¼ˆä»… --legacy æ¨¡å¼ï¼‰

### ğŸš¨ğŸš¨ğŸš¨ MUST EXECUTE (if LEGACY=true) ğŸš¨ğŸš¨ğŸš¨

**ä»…å½“ LEGACY=true æ—¶æ‰§è¡Œæ­¤é˜¶æ®µ**

**Skill è°ƒç”¨ï¼š**

```
Skill(skill="refactor:legacy-analyzer", args="run_dir=${RUN_DIR} source_stack=${SOURCE_STACK} target_stack=${TARGET_STACK}")
```

**éªŒè¯**ï¼š

- ç¡®è®¤ `${RUN_DIR}/legacy-analysis.md` å·²ç”Ÿæˆ
- ç¡®è®¤ `${RUN_DIR}/migration-plan.json` å·²ç”Ÿæˆ

**é—ç•™ç³»ç»Ÿåˆ†æå†…å®¹**ï¼š

- å½“å‰æ¶æ„æ¨¡å¼è¯†åˆ«ï¼ˆå•ä½“/åˆ†å±‚/æ¨¡å—åŒ–ï¼‰
- æŠ€æœ¯å€ºåŠ¡è¯„ä¼°
- è¿ç§»æ¥ç¼ï¼ˆSeamsï¼‰è¯†åˆ«
- æ¨èè¿ç§»ç­–ç•¥ï¼ˆStrangler Fig / Big Bang / Incrementalï¼‰
- é£é™©è¯„ä¼°å’Œæ—¶é—´çº¿

**äº§å‡ºå°†å½±å“åç»­ Phase**ï¼š

- smell-detector ä¼šæ£€æµ‹é—ç•™ç³»ç»Ÿç‰¹æœ‰çš„æ°”å‘³
- refactor-suggester ä¼šç”Ÿæˆè¿ç§»ç›¸å…³çš„é‡æ„å»ºè®®
- æ‰§è¡Œç­–ç•¥ä¼šè€ƒè™‘è¿ç§»é˜¶æ®µ

---

## Phase 2: ä»£ç æ°”å‘³æ£€æµ‹

### ğŸš¨ğŸš¨ğŸš¨ MUST EXECUTE ğŸš¨ğŸš¨ğŸš¨

**ç«‹å³è°ƒç”¨ Skill å·¥å…·ï¼š**

```
# å¸¸è§„æ¨¡å¼
Skill(skill="refactor:smell-detector", args="run_dir=${RUN_DIR} target=${TARGET}")

# Legacy æ¨¡å¼ï¼ˆä¼ é€’ legacy æ ‡å¿—ï¼Œå¯ç”¨é—ç•™ç³»ç»Ÿæ°”å‘³æ£€æµ‹ï¼‰
Skill(skill="refactor:smell-detector", args="run_dir=${RUN_DIR} target=${TARGET} legacy=true")
```

**éªŒè¯**ï¼š

- ç¡®è®¤ `${RUN_DIR}/smells.json` å·²ç”Ÿæˆ
- ç¡®è®¤ `${RUN_DIR}/smells-report.md` å·²ç”Ÿæˆ

**æ£€æµ‹çš„ä»£ç æ°”å‘³ç±»å‹**ï¼š

- é‡å¤ä»£ç  (Duplicated Code)
- è¿‡é•¿å‡½æ•° (Long Method)
- è¿‡å¤§ç±» (Large Class / God Class)
- è¿‡é•¿å‚æ•°åˆ—è¡¨ (Long Parameter List)
- æ•£å¼¹å¼ä¿®æ”¹ (Shotgun Surgery)
- ä¾æ‹æƒ…ç»“ (Feature Envy)
- æ•°æ®æ³¥å›¢ (Data Clumps)
- è¿‡åº¦è€¦åˆ (Tight Coupling)

---

## Phase 3: é‡æ„å»ºè®®ç”Ÿæˆ

### ğŸš¨ğŸš¨ğŸš¨ MUST EXECUTE - DO NOT SKIP ğŸš¨ğŸš¨ğŸš¨

**âŒ ç¦æ­¢è¡Œä¸ºï¼š**

- âŒ è‡ªå·±ç”Ÿæˆé‡æ„å»ºè®®
- âŒ è·³è¿‡ Skill è°ƒç”¨

**âœ… å”¯ä¸€æ­£ç¡®åšæ³•ï¼šè°ƒç”¨ Skill å·¥å…·**

### ç«‹å³æ‰§è¡Œ

**Skill è°ƒç”¨ï¼š**

```
Skill(skill="refactor:refactor-suggester", args="run_dir=${RUN_DIR}")
```

**éªŒè¯**ï¼šç¡®è®¤ `${RUN_DIR}/suggestions.json` å·²ç”Ÿæˆ

**ç”Ÿæˆçš„é‡æ„å»ºè®®ç±»å‹**ï¼š

- æå–æ–¹æ³• (Extract Method)
- æå–ç±» (Extract Class)
- å†…è” (Inline)
- ç§»åŠ¨æ–¹æ³•/å­—æ®µ (Move Method/Field)
- é‡å‘½å (Rename)
- å¼•å…¥å‚æ•°å¯¹è±¡ (Introduce Parameter Object)
- ç”¨å¤šæ€æ›¿æ¢æ¡ä»¶è¡¨è¾¾å¼ (Replace Conditional with Polymorphism)
- å°è£…å­—æ®µ (Encapsulate Field)

---

## Phase 4: å½±å“èŒƒå›´åˆ†æ

### ğŸš¨ğŸš¨ğŸš¨ MUST EXECUTE - DO NOT SKIP ğŸš¨ğŸš¨ğŸš¨

**âŒ ç¦æ­¢è¡Œä¸ºï¼ˆè¿ååˆ™å·¥ä½œæµå¤±è´¥ï¼‰ï¼š**

- âŒ è·³è¿‡å½±å“åˆ†æç›´æ¥é‡æ„
- âŒ è‡ªå·±çŒœæµ‹å½±å“èŒƒå›´

**âœ… å”¯ä¸€æ­£ç¡®åšæ³•ï¼šè°ƒç”¨ Skill å·¥å…·**

### ç«‹å³æ‰§è¡Œ

**Skill è°ƒç”¨ï¼š**

```
Skill(skill="refactor:impact-analyzer", args="run_dir=${RUN_DIR}")
```

**éªŒè¯**ï¼šç¡®è®¤ `${RUN_DIR}/impact-analysis.md` å·²ç”Ÿæˆ

**å½±å“åˆ†æå†…å®¹**ï¼š

- å—å½±å“çš„æ–‡ä»¶åˆ—è¡¨
- å—å½±å“çš„ç¬¦å·ï¼ˆå‡½æ•°/ç±»/å˜é‡ï¼‰
- è°ƒç”¨å…³ç³»é“¾
- æµ‹è¯•è¦†ç›–èŒƒå›´
- é£é™©è¯„ä¼°ï¼ˆä½/ä¸­/é«˜/æé«˜ï¼‰

**â¸ï¸ ç¡¬åœæ­¢**ï¼šå±•ç¤ºå½±å“åˆ†æç»“æœï¼Œç”¨æˆ·ç¡®è®¤åç»§ç»­

---

## Phase 5: å®‰å…¨é‡æ„æ‰§è¡Œ

### ğŸš¨ğŸš¨ğŸš¨ MUST EXECUTE - DO NOT SKIP ğŸš¨ğŸš¨ğŸš¨

**âŒ ç¦æ­¢è¡Œä¸ºï¼ˆè¿ååˆ™å·¥ä½œæµå¤±è´¥ï¼‰ï¼š**

- âŒ è‡ªå·±ç”¨ Write/Edit å·¥å…·æ‰§è¡Œé‡æ„
- âŒ è·³è¿‡ Skill è°ƒç”¨ç›´æ¥ä¿®æ”¹æ–‡ä»¶
- âŒ æœªç¡®è®¤å°±æ‰§è¡Œé«˜é£é™©é‡æ„

**âœ… å”¯ä¸€æ­£ç¡®åšæ³•ï¼šè°ƒç”¨ Skill å·¥å…·**

### æ‰§è¡Œæ¡ä»¶

| æ¨¡å¼        | è¡Œä¸º                             |
| ----------- | -------------------------------- |
| analyze     | è·³è¿‡æ­¤é˜¶æ®µï¼Œä»…è¾“å‡ºåˆ†ææŠ¥å‘Š       |
| auto        | è‡ªåŠ¨æ‰§è¡Œä½é£é™©é‡æ„ï¼Œé«˜é£é™©éœ€ç¡®è®¤ |
| interactive | æ¯ä¸ªé‡æ„æ“ä½œé€ä¸€ç¡®è®¤             |

### ç«‹å³æ‰§è¡Œï¼ˆé analyze æ¨¡å¼ï¼‰

**Skill è°ƒç”¨ï¼š**

```
Skill(skill="refactor:refactor-executor", args="run_dir=${RUN_DIR} mode=${MODE}")
```

**éªŒè¯**ï¼š

- ç¡®è®¤ `${RUN_DIR}/changes.md` å·²ç”Ÿæˆ
- ç¡®è®¤ `${RUN_DIR}/refactor-result.json` å·²ç”Ÿæˆ

---

## Phase 6: äº¤ä»˜

è¾“å‡ºå®Œæˆæ‘˜è¦ï¼š

```
ğŸ‰ é‡æ„ä»»åŠ¡å®Œæˆï¼

ğŸ“‹ ç›®æ ‡: ${TARGET}
ğŸ”€ æ¨¡å¼: ${MODE}

ğŸ“Š æ£€æµ‹ç»“æœ:
- ä»£ç æ°”å‘³: X ä¸ª
- é‡æ„å»ºè®®: Y ä¸ª
- å·²æ‰§è¡Œ: Z ä¸ª
- è·³è¿‡: W ä¸ª

âš ï¸ é£é™©åˆ†å¸ƒ:
- ä½é£é™©: A ä¸ª âœ…
- ä¸­é£é™©: B ä¸ª âš¡
- é«˜é£é™©: C ä¸ª ğŸ”¶
- æé«˜é£é™©: D ä¸ª ğŸ”´

ğŸ“ äº§ç‰©:
  ${RUN_DIR}/
  â”œâ”€â”€ smells.json           # ä»£ç æ°”å‘³æ•°æ®
  â”œâ”€â”€ smells-report.md      # æ°”å‘³æ£€æµ‹æŠ¥å‘Š
  â”œâ”€â”€ suggestions.json      # é‡æ„å»ºè®®æ•°æ®
  â”œâ”€â”€ impact-analysis.md    # å½±å“åˆ†ææŠ¥å‘Š
  â”œâ”€â”€ changes.md            # å˜æ›´æ¸…å•
  â””â”€â”€ refactor-result.json  # æ‰§è¡Œç»“æœ

ğŸ”„ åç»­:
  - æ–­ç‚¹ç»­ä¼ : /refactor --run-id=${RUN_ID}
  - è¿è¡Œæµ‹è¯•: npm test
  - æŸ¥çœ‹å˜æ›´: git diff
```

---

## è¿è¡Œç›®å½•ç»“æ„

```
openspec/changes/20260115T100000Z/
â”œâ”€â”€ state.json              # å·¥ä½œæµçŠ¶æ€
â”œâ”€â”€ target.txt              # é‡æ„ç›®æ ‡
â”œâ”€â”€ smells.json             # Phase 2: ä»£ç æ°”å‘³æ•°æ®
â”œâ”€â”€ smells-report.md        # Phase 2: æ°”å‘³æ£€æµ‹æŠ¥å‘Š
â”œâ”€â”€ suggestions.json        # Phase 3: é‡æ„å»ºè®®
â”œâ”€â”€ impact-analysis.md      # Phase 4: å½±å“åˆ†æ
â”œâ”€â”€ changes.md              # Phase 5: å˜æ›´æ¸…å•
â””â”€â”€ refactor-result.json    # Phase 5: æ‰§è¡Œç»“æœ
```

## é‡æ„æ¨¡å¼

| æ¨¡å¼        | è¯´æ˜     | æµç¨‹                                |
| ----------- | -------- | ----------------------------------- |
| analyze     | ä»…åˆ†æ   | æ£€æµ‹ â†’ å»ºè®® â†’ åˆ†æï¼ˆä¸æ‰§è¡Œï¼‰        |
| auto        | è‡ªåŠ¨æ‰§è¡Œ | æ£€æµ‹ â†’ å»ºè®® â†’ åˆ†æ â†’ è‡ªåŠ¨æ‰§è¡Œä½é£é™© |
| interactive | äº¤äº’å¼   | æ£€æµ‹ â†’ å»ºè®® â†’ åˆ†æ â†’ é€ä¸€ç¡®è®¤æ‰§è¡Œ   |

## å‚è€ƒèµ„æº

- Skills: `skills/smell-detector/`, `skills/refactor-suggester/`, `skills/impact-analyzer/`, `skills/refactor-executor/`
- ä»£ç æ°”å‘³å‚è€ƒ: `skills/smell-detector/references/smell-catalog.md`
- é‡æ„æ¨¡å¼å‚è€ƒ: `skills/refactor-suggester/references/refactoring-patterns.md`
