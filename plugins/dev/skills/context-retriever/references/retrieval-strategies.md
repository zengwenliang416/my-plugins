# Context Retrieval Strategies Reference

上下文检索策略：内部代码检索 + 外部文档搜索。

---

## 1. 内部代码检索

### 1.1 工具选择

| 工具 | 适用场景 | 优先级 |
|------|----------|--------|
| `auggie-mcp` | 语义检索、理解代码意图 | 1 |
| `LSP` | 符号级精准操作 | 2 |
| `Glob/Grep` | 模式匹配、关键词搜索 | 3 |

### 1.2 auggie-mcp 查询模板

**功能定位**:
```
找到处理 [功能描述] 的代码位置，包括：
1. 主要实现文件
2. 相关的接口/类型定义
3. 调用该功能的位置
```

**架构理解**:
```
分析 [模块/目录] 的代码结构：
1. 主要组件和职责
2. 模块间依赖关系
3. 数据流向
```

**变更影响**:
```
如果修改 [文件/函数]，会影响哪些代码：
1. 直接调用者
2. 依赖的接口
3. 测试覆盖
```

### 1.3 LSP 操作序列

| 场景 | LSP 操作 | 目的 |
|------|----------|------|
| 理解文件结构 | `documentSymbol` | 获取符号列表 |
| 跟踪定义 | `goToDefinition` | 找到符号定义 |
| 找引用 | `findReferences` | 找所有使用处 |
| 查看类型 | `hover` | 获取类型信息 |
| 调用链分析 | `incomingCalls` / `outgoingCalls` | 理解调用关系 |

### 1.4 检索优先级

```
1. 先用 auggie-mcp 定位相关文件
2. 对关键文件用 LSP 深入分析
3. 必要时用 Glob/Grep 补充搜索
```

---

## 2. 外部文档搜索

### 2.1 exa Skill 使用

**搜索查询模板**:

```
exa skill args="search [技术名] [具体问题] site:docs.* OR site:github.com"
```

**示例查询**:
- `React hooks useEffect cleanup site:react.dev`
- `TypeScript generic constraints site:typescriptlang.org`
- `Next.js app router migration site:nextjs.org`

### 2.2 搜索策略

| 需求类型 | 搜索关键词 | 推荐来源 |
|----------|------------|----------|
| API 用法 | `[lib] [method] example` | 官方文档 |
| 最佳实践 | `[lib] best practices 2026` | 博客、教程 |
| 错误解决 | `[error message] solution` | GitHub Issues, StackOverflow |
| 迁移指南 | `[lib] migration guide v[x] to v[y]` | 官方文档 |

### 2.3 来源优先级

```
1. 官方文档 (*.dev, *.io, docs.*)
2. GitHub 仓库 README/Wiki
3. 知名博客 (dev.to, medium.com)
4. StackOverflow
```

---

## 3. Token 限制策略

### 3.1 上下文预算分配

```
总预算: 32k tokens (Gemini) / 128k tokens (Codex)

分配建议:
- 需求描述: 5%
- 内部代码: 60%
- 外部文档: 25%
- 保留空间: 10%
```

### 3.2 内容精简规则

| 内容类型 | 精简策略 |
|----------|----------|
| 代码文件 | 只保留相关函数/类，删除无关代码 |
| 文档 | 提取关键段落，删除导航/版权信息 |
| API 响应 | 只保留示例和参数说明 |

### 3.3 截断策略

```
优先保留:
1. 核心实现代码
2. 接口/类型定义
3. 关键配置

可截断:
1. 注释（保留关键注释）
2. 导入语句（总结依赖）
3. 测试代码（除非测试相关）
```

---

## 4. 检索模板

### 4.1 新功能开发

```markdown
## 内部代码

### 相关文件
- [文件路径]: [简要说明]

### 接口定义
[相关接口代码]

### 现有实现参考
[类似功能的实现]

## 外部文档

### 官方指南
- [文档链接]: [关键内容摘要]

### 最佳实践
- [来源]: [实践要点]
```

### 4.2 Bug 修复

```markdown
## 问题定位

### 错误位置
- 文件: [路径:行号]
- 函数: [函数名]

### 调用链
[调用栈分析]

### 相关代码
[问题代码上下文]

## 参考方案

### 类似问题
- [Issue/PR 链接]: [解决方案]

### 文档参考
- [文档链接]: [相关说明]
```

### 4.3 重构任务

```markdown
## 当前状态

### 代码结构
[现有结构分析]

### 依赖关系
[模块依赖图]

### 影响范围
[受影响的文件列表]

## 重构参考

### 设计模式
- [模式名]: [应用建议]

### 案例参考
- [来源]: [重构方案]
```

---

## 5. 输出格式

### 5.1 context.md 结构

```markdown
---
retrieved_at: 2026-01-17T12:00:00Z
task: [任务描述]
token_usage:
  internal: [数量]
  external: [数量]
  total: [数量]
---

# 上下文检索结果

## 任务概述

[任务描述]

## 内部代码

### 核心文件

#### [文件路径]

\`\`\`typescript
[代码内容]
\`\`\`

### 相关接口

[接口定义]

### 依赖关系

[依赖图/列表]

## 外部文档

### [来源名称]

[摘要内容]

**链接**: [URL]

## 检索摘要

- 内部文件: [数量] 个
- 外部文档: [数量] 篇
- Token 使用: [数量]
```

---

## 6. 错误处理

### 6.1 检索失败

| 错误 | 处理 |
|------|------|
| auggie-mcp 超时 | 降级到 Glob/Grep |
| LSP 不可用 | 使用 Read 工具 |
| exa 搜索失败 | 使用 WebSearch/WebFetch |

### 6.2 结果验证

```
检查项:
- [ ] 内部代码是否覆盖核心文件
- [ ] 外部文档是否来自可信来源
- [ ] Token 使用是否在预算内
- [ ] 是否有重复/冗余内容
```
