---
name: plan-synthesizer
description: |
  ã€è§¦å‘æ¡ä»¶ã€‘plan å·¥ä½œæµç¬¬å…­æ­¥ï¼šæ•´åˆæ‰€æœ‰äº§ç‰©ç”Ÿæˆæœ€ç»ˆè®¡åˆ’
  ã€æ ¸å¿ƒäº§å‡ºã€‘è¾“å‡º ${run_dir}/plan.mdï¼ˆåŒ…å« OpenSpec çº¦æŸä¸ PBT å±æ€§ï¼‰
  ã€ç¡¬åœæ­¢ã€‘å¿…é¡»ç­‰å¾…ç”¨æˆ·æ‰¹å‡†
allowed-tools:
  - Read
  - Write
  - mcp__sequential-thinking__sequentialthinking
arguments:
  - name: run_dir
    type: string
    required: true
    description: è¿è¡Œç›®å½•è·¯å¾„ï¼ˆç”± orchestrator ä¼ å…¥ï¼‰
---

# Plan Synthesizer - è®¡åˆ’æ•´åˆåŸå­æŠ€èƒ½

## èŒè´£è¾¹ç•Œ

- **è¾“å…¥**: `run_dir` + æ‰€æœ‰å‰ç½®äº§ç‰©ï¼ˆå« OpenSpec ææ¡ˆä¸çº¦æŸï¼‰
- **è¾“å‡º**: `${run_dir}/plan.md`
- **å•ä¸€èŒè´£**: åªåšè®¡åˆ’æ•´åˆï¼Œä¸åšæ–°çš„åˆ†æ

## MCP å·¥å…·é›†æˆ

| MCP å·¥å…·              | ç”¨é€”                         | è§¦å‘æ¡ä»¶        |
| --------------------- | ---------------------------- | --------------- |
| `sequential-thinking` | ç»“æ„åŒ–è®¡åˆ’æ•´åˆï¼Œç¡®ä¿ä¿¡æ¯å®Œæ•´ | ğŸš¨ æ¯æ¬¡æ‰§è¡Œå¿…ç”¨ |

## æ‰§è¡Œæµç¨‹

### Step 0: ç»“æ„åŒ–æ•´åˆè§„åˆ’ï¼ˆsequential-thinkingï¼‰

ğŸš¨ **å¿…é¡»é¦–å…ˆä½¿ç”¨ sequential-thinking è§„åˆ’æ•´åˆç­–ç•¥**

```
mcp__sequential-thinking__sequentialthinking({
  thought: "è§„åˆ’è®¡åˆ’æ•´åˆç­–ç•¥ã€‚éœ€è¦ï¼š1) è¯»å–æ‰€æœ‰äº§ç‰© 2) æå–å…³é”®æ‘˜è¦ 3) éªŒè¯ä¸€è‡´æ€§ 4) ç”Ÿæˆæ‰§è¡Œæ‘˜è¦ 5) æ„å»ºè·¯çº¿å›¾",
  thoughtNumber: 1,
  totalThoughts: 5,
  nextThoughtNeeded: true
})
```

**æ€è€ƒæ­¥éª¤**ï¼š

1. **äº§ç‰©å®Œæ•´æ€§éªŒè¯**ï¼šç¡®è®¤æ‰€æœ‰å‰ç½®æ–‡ä»¶å­˜åœ¨
2. **å…³é”®ä¿¡æ¯æå–**ï¼šä»æ¯ä¸ªäº§ç‰©æå–æ ¸å¿ƒå†…å®¹
3. **ä¸€è‡´æ€§æ£€æŸ¥**ï¼šéªŒè¯éœ€æ±‚/æ¶æ„/ä»»åŠ¡/é£é™©ä¹‹é—´çš„ä¸€è‡´æ€§
4. **æ‘˜è¦ç”Ÿæˆ**ï¼šç”Ÿæˆç®€æ´çš„æ‰§è¡Œæ‘˜è¦
5. **è·¯çº¿å›¾æ„å»º**ï¼šæ•´åˆé‡Œç¨‹ç¢‘å’Œå…³é”®è·¯å¾„

### Step 1: è¯»å–æ‰€æœ‰äº§ç‰©

```bash
INPUT=$(cat "${run_dir}/input.md")
REQUIREMENTS=$(cat "${run_dir}/requirements.md")  # å¦‚ç¼ºå¤±ï¼Œç”¨ proposal.md æ›¿ä»£
PROPOSAL=$(cat "${run_dir}/proposal.md")
CONSTRAINTS=$(cat "${run_dir}/constraints.md")
PBT=$(cat "${run_dir}/pbt.md")
CONTEXT=$(cat "${run_dir}/context.md")
ARCHITECTURE=$(cat "${run_dir}/architecture.md")
TASKS=$(cat "${run_dir}/tasks.md")
RISKS=$(cat "${run_dir}/risks.md")
AMBIGUITIES=$(cat "${run_dir}/ambiguities.md")
```

### Step 2: æå–æ‘˜è¦

ä»æ¯ä¸ªäº§ç‰©ä¸­æå–å…³é”®ä¿¡æ¯ï¼š

| äº§ç‰©            | æå–å†…å®¹                     |
| --------------- | ---------------------------- |
| proposal.md     | ææ¡ˆæ‘˜è¦ã€ç›®æ ‡ä¸éç›®æ ‡       |
| constraints.md  | çº¦æŸä¸æ˜ç¡®å†³ç­–               |
| pbt.md          | ä¸å˜å¼ä¸åä¾‹ç­–ç•¥             |
| requirements.md | æ ¸å¿ƒéœ€æ±‚ã€ä»»åŠ¡ç±»å‹ã€éªŒæ”¶æ ‡å‡† |
| context.md      | å…³é”®æ–‡ä»¶ã€æŠ€æœ¯æ ˆã€ä¾èµ–       |
| architecture.md | æ¶æ„å†³ç­–ã€API è®¾è®¡ã€ç»„ä»¶ç»“æ„ |
| tasks.md        | ä»»åŠ¡æ•°é‡ã€å…³é”®è·¯å¾„ã€é‡Œç¨‹ç¢‘   |
| risks.md        | é«˜é£é™©ã€å¿…è¦ç¼“è§£æªæ–½         |

### Step 3: æå–ææ¡ˆ ID

```bash
PROPOSAL_ID=$(jq -r '.proposal_id // empty' "${run_dir}/state.json")
```

### Step 4: è®¡ç®—é¢„ä¼°

æ±‡æ€»ä»»åŠ¡å¤æ‚åº¦ï¼š

| å¤æ‚åº¦ | åŸºå‡† | ä»»åŠ¡æ•° | å°è®¡ |
| ------ | ---- | ------ | ---- |
| 1/5    | -    | X      | -    |
| 2/5    | -    | Y      | -    |
| 3/5    | -    | Z      | -    |
| 4/5    | -    | W      | -    |
| 5/5    | -    | V      | -    |

### Step 5: è¯„ä¼°é£é™©ç­‰çº§

| æ¡ä»¶           | æ•´ä½“é£é™©ç­‰çº§ |
| -------------- | ------------ |
| æœ‰ HIGH é£é™©   | é«˜           |
| æœ‰ MEDIUM é£é™© | ä¸­           |
| ä»… LOW é£é™©    | ä½           |

### Step 6: ç»“æ„åŒ–è¾“å‡º

å°†æ•´åˆç»“æœå†™å…¥ `${run_dir}/plan.md`ï¼š

```markdown
# å¼€å‘å®æ–½è®¡åˆ’

## å…ƒä¿¡æ¯

| å±æ€§     | å€¼                             |
| -------- | ------------------------------ |
| ææ¡ˆ ID  | [PROPOSAL_ID]                   |
| ç”Ÿæˆæ—¶é—´ | [timestamp]                    |
| ä»»åŠ¡ç±»å‹ | [frontend\|backend\|fullstack] |
| æ€»ä»»åŠ¡æ•° | [count]                        |
| é£é™©ç­‰çº§ | [ä½\|ä¸­\|é«˜]                   |

---

## æ‰§è¡Œæ‘˜è¦

### éœ€æ±‚æ¦‚è¿°

[ä» requirements.md æå–çš„ä¸€æ®µè¯æè¿°]

### æŠ€æœ¯æ–¹æ¡ˆ

[ä» architecture.md æå–çš„ä¸€æ®µè¯æè¿°]

### å…³é”®é£é™©

| é£é™©    | ç­‰çº§   | ç¼“è§£æªæ–½ |
| ------- | ------ | -------- |
| [é£é™©1] | HIGH   | [æªæ–½]   |
| [é£é™©2] | MEDIUM | [æªæ–½]   |

---

## éœ€æ±‚è§„æ ¼

### åŠŸèƒ½éœ€æ±‚

| ID     | éœ€æ±‚æè¿° | ä¼˜å…ˆçº§ |
| ------ | -------- | ------ |
| FR-001 | [æè¿°]   | P1     |
| FR-002 | [æè¿°]   | P2     |

### éåŠŸèƒ½éœ€æ±‚

| ID      | ç±»åˆ« | çº¦æŸæè¿°          |
| ------- | ---- | ----------------- |
| NFR-001 | æ€§èƒ½ | API å“åº” < 200ms  |
| NFR-002 | å®‰å…¨ | OWASP Top 10 åˆè§„ |

### éªŒæ”¶æ ‡å‡†

- [ ] [æ ‡å‡†1]
- [ ] [æ ‡å‡†2]
- [ ] [æ ‡å‡†3]

---

## OpenSpec çº¦æŸä¸åˆ¤æ®

### çº¦æŸ

- **ç¡¬çº¦æŸ**: [æ¥è‡ª constraints.md]
- **è½¯çº¦æŸ**: [æ¥è‡ª constraints.md]

### éç›®æ ‡

- [æ¥è‡ª proposal.md / constraints.md]

### æˆåŠŸåˆ¤æ®

- [æ¥è‡ª proposal.md / synthesis]

### PBT å±æ€§

- [INVARIANT] ... â†’ [FALSIFICATION] ...

---

## æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„å›¾
```

[ASCII æ¶æ„å›¾æˆ– Mermaid]

````

### å…³é”®ç»„ä»¶

| ç»„ä»¶ | ç±»å‹ | èŒè´£ |
|-----|-----|-----|
| AuthService | åç«¯æœåŠ¡ | è®¤è¯é€»è¾‘ |
| LoginForm | å‰ç«¯ç»„ä»¶ | ç™»å½•ç•Œé¢ |

### æ¶æ„å†³ç­–

| å†³ç­– | é€‰æ‹© | ç†ç”± |
|-----|-----|-----|
| è®¤è¯æ–¹æ¡ˆ | JWT + OAuth2 | è¡Œä¸šæ ‡å‡† |
| çŠ¶æ€ç®¡ç† | Zustand | è½»é‡çº§ |

---

## å®æ–½è·¯çº¿å›¾

### é˜¶æ®µåˆ’åˆ†

```mermaid
gantt
    title å®æ–½è·¯çº¿å›¾
    dateFormat  YYYY-MM-DD
    section é˜¶æ®µ1
    åŸºç¡€è®¾æ–½       :a1, 2026-01-19, 1d
    section é˜¶æ®µ2
    åç«¯ API       :a2, after a1, 1d
    section é˜¶æ®µ3
    å‰ç«¯å¼€å‘       :a3, after a1, 2d
    section é˜¶æ®µ4
    é›†æˆè”è°ƒ       :a4, after a2 a3, 1d
````

### å…³é”®è·¯å¾„

```
T-001 â†’ T-002 â†’ T-006 â†’ T-011 â†’ T-012
```

### é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘           | å®Œæˆæ¡ä»¶      | éªŒæ”¶æ ‡å‡†         |
| ---------------- | ------------- | ---------------- |
| M1: åŸºç¡€è®¾æ–½å°±ç»ª | T-001 ~ T-004 | æ•°æ®åº“å¯è¿æ¥     |
| M2: API å¯ç”¨     | T-005, T-006  | Swagger å¯è®¿é—®   |
| M3: å‰ç«¯åŸå‹     | T-009, T-010  | Storybook å¯æ¼”ç¤º |
| M4: åŠŸèƒ½å®Œæˆ     | å…¨éƒ¨ä»»åŠ¡      | E2E æµ‹è¯•é€šè¿‡     |

### ä»»åŠ¡æ¸…å•

| é˜¶æ®µ | ID    | ä»»åŠ¡               | ç±»å‹    | å¤æ‚åº¦ | ä¾èµ–  |
| ---- | ----- | ------------------ | ------- | ------ | ----- |
| 1    | T-001 | åˆ›å»ºæ•°æ®åº“è¿ç§»     | backend | 2/5    | -     |
| 1    | T-002 | å®ç° Prisma Schema | backend | 2/5    | T-001 |
| ...  | ...   | ...                | ...     | ...    | ...   |

---

## é£é™©ä¸ç¼“è§£

### é£é™©ç™»è®°è¡¨

| ID    | é£é™©       | ç­‰çº§   | ç¼“è§£æªæ–½  | çŠ¶æ€   |
| ----- | ---------- | ------ | --------- | ------ |
| R-001 | æ•°æ®åº“è¿ç§» | MEDIUM | å¤‡ä»½+å›æ»š | å¾…å¤„ç† |
| R-002 | JWT æ³„éœ²   | MEDIUM | å¯†é’¥è½®æ¢  | å¾…å¤„ç† |

### å¿…é¡»å¤„ç†ï¼ˆé˜»å¡å‘å¸ƒï¼‰

1. **R-001: å‡†å¤‡æ•°æ®åº“è¿ç§»å›æ»šæ–¹æ¡ˆ**
   - è´£ä»»äºº: DBA
   - éªŒè¯: å›æ»šæµ‹è¯•é€šè¿‡

2. **R-002: å®ç° JWT secret è½®æ¢æœºåˆ¶**
   - è´£ä»»äºº: åç«¯å¼€å‘
   - éªŒè¯: å¯†é’¥è½®æ¢æµ‹è¯•

---

## éªŒè¯è®¡åˆ’

### æµ‹è¯•ç­–ç•¥

| æµ‹è¯•ç±»å‹ | å·¥å…·       | è¦†ç›–ç›®æ ‡     |
| -------- | ---------- | ------------ |
| å•å…ƒæµ‹è¯• | Jest       | æ ¸å¿ƒé€»è¾‘ 80% |
| é›†æˆæµ‹è¯• | Supertest  | API 100%     |
| E2E æµ‹è¯• | Playwright | å…³é”®æµç¨‹     |

### è´¨é‡é—¨ç¦

- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] E2E æµ‹è¯•é€šè¿‡
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡
- [ ] å®‰å…¨æ‰«ææ— é«˜å±
- [ ] æ€§èƒ½æµ‹è¯•è¾¾æ ‡

---

## åç»­æ“ä½œ

### æ‰¹å‡†æ­¤è®¡åˆ’

ç¡®è®¤ä»¥ä¸Šè®¡åˆ’åï¼Œæ‰§è¡Œå¼€å‘ï¼š

```bash
/tpd:dev --proposal-id=${PROPOSAL_ID}
```

### äº§ç‰©æ¸…å•

```
  ${run_dir}/
â”œâ”€â”€ input.md           # åŸå§‹è¾“å…¥
â”œâ”€â”€ proposal.md        # OpenSpec ææ¡ˆ
â”œâ”€â”€ constraints.md     # çº¦æŸä¸å†³ç­–
â”œâ”€â”€ pbt.md             # PBT å±æ€§
â”œâ”€â”€ requirements.md    # éœ€æ±‚è§„æ ¼
â”œâ”€â”€ context.md         # ä»£ç ä¸Šä¸‹æ–‡
â”œâ”€â”€ architecture.md    # æ¶æ„è®¾è®¡
â”œâ”€â”€ tasks.md           # ä»»åŠ¡åˆ†è§£
â”œâ”€â”€ risks.md           # é£é™©è¯„ä¼°
â””â”€â”€ plan.md            # æœ¬è®¡åˆ’æ–‡æ¡£
```

---

**ææ¡ˆ ID**: `${PROPOSAL_ID}`
**ç”Ÿæˆæ—¶é—´**: [timestamp]
**çŠ¶æ€**: å¾…æ‰¹å‡†

```

## è¿”å›å€¼

æ‰§è¡Œå®Œæˆåï¼Œè¿”å›ï¼š

```

è®¡åˆ’æ•´åˆå®Œæˆã€‚
è¾“å‡ºæ–‡ä»¶: ${run_dir}/plan.md
ä»»åŠ¡æ•°: X ä¸ª
é£é™©ç­‰çº§: [ä½|ä¸­|é«˜]

â¸ï¸ ç­‰å¾…ç”¨æˆ·æ‰¹å‡†...

æ‰¹å‡†åæ‰§è¡Œ: /tpd:dev --proposal-id=${PROPOSAL_ID}

```

## è´¨é‡é—¨æ§

- âœ… æ•´åˆäº†æ‰€æœ‰å‰ç½®äº§ç‰©ï¼ˆå« OpenSpec çº¦æŸ/PBTï¼‰
- âœ… ç”Ÿæˆäº†æ‰§è¡Œæ‘˜è¦
- âœ… åŒ…å«äº†å®æ–½è·¯çº¿å›¾
- âœ… åˆ—å‡ºäº†éªŒæ”¶æ ‡å‡†
- âœ… æä¾›äº†åç»­æ“ä½œæŒ‡å¼•

## çº¦æŸ

- ä¸åšæ–°çš„åˆ†æï¼Œåªæ•´åˆå·²æœ‰äº§ç‰©
- å¿…é¡»ç­‰å¾…ç”¨æˆ·æ‰¹å‡†
- è®¡åˆ’æ–‡æ¡£å¿…é¡»å¯ç‹¬ç«‹é˜…è¯»
- å¿…é¡»åŒ…å«åç»­æ“ä½œæŒ‡å¼•
```
