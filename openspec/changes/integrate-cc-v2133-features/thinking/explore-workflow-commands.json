{
  "module_name": "workflow-commands",
  "existing_structures": [
    "9 command .md files across 6 plugins (hooks plugin has no commands)",
    "plugins/tpd/commands/thinking.md - /tpd:thinking: 6-step deep analysis with parallel boundary exploration (max 4 agents) + parallel constraint analysis (max 2 agents)",
    "plugins/tpd/commands/plan.md - /tpd:plan: 6-step planning with parallel context+requirements retrieval (max 2 agents) + parallel multi-model architecture planning (max 2 agents)",
    "plugins/tpd/commands/dev.md - /tpd:dev: 7-step development with 3 parallel steps: context+analysis (2), prototype generation (2), audit (2). Already has experimental Agent Teams section (lines 351-387)",
    "plugins/tpd/commands/init.md - /tpd:init: 5-step sequential initialization (no Task subagents, no parallelism)",
    "plugins/commit/commands/commit.md - /commit: 10-phase workflow with Phase 3 parallel fork-join (2 agents: semantic-analyzer + symbol-analyzer with run_in_background=true)",
    "plugins/ui-design/commands/ui-design.md - /ui-design: 10-phase workflow with Phase 6 parallel design variant generation (up to 3 agents with run_in_background=true, uses TaskOutput to wait)",
    "plugins/brainstorm/commands/brainstorm.md - /brainstorm: 5-phase sequential Skill-only workflow (no Task subagents at command level; multi-model parallelism is internal to idea-generator Skill)",
    "plugins/refactor/commands/refactor.md - /refactor: 6-phase sequential Skill-only workflow (no Task subagents; each phase depends on previous output)",
    "plugins/context-memory/commands/memory.md - /memory: Command router to Skill calls (no Task subagents; sequential loop for claude-full/claude-related)"
  ],
  "existing_conventions": [
    "Parallel execution via Task tool with run_in_background=true, waited on by orchestrator",
    "All inter-agent communication is file-based via shared run directory (no direct messaging)",
    "JUST RUN AND WAIT pattern in TPD workflows (agents launched synchronously, not in background)",
    "Maximum parallel agent caps documented per step (4 for boundary-explorer, 2 for most others, 3 for ui-design variants)",
    "Skill tool used for atomic operations; Task tool used for parallel subagent work",
    "Fork-join pattern: launch N independent agents -> wait all -> merge/synthesize results",
    "Each parallel agent writes to a separate output file (e.g., codex-plan.md vs gemini-plan.md, semantic-analysis.json vs symbol-analysis.json)",
    "Cross-model isolation: codex and gemini operate on independent tracks",
    "Phase-gated execution with checkpoints (state.json tracking) and hard stops (AskUserQuestion)",
    "Agent type restrictions: each command declares allowed agent types, all others forbidden"
  ],
  "constraints_discovered": [
    "CONSTRAINT-WC-01: /tpd:dev already has Agent Teams section (lines 351-387) gated by CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1 env var. New integration must align with this existing design.",
    "CONSTRAINT-WC-02: Existing Agent Teams design in dev.md explicitly FORBIDS cross-model mailbox (codex-implementer cannot message gemini-implementer). This conflicts with Agent Teams inter-agent messaging feature.",
    "CONSTRAINT-WC-03: Agent Teams max 2 iterations in dev.md team cycle before falling back to manual review.",
    "CONSTRAINT-WC-04: 5 of 9 commands use NO parallel Task subagents (init, brainstorm, refactor, memory, and partially plan Step 4 which uses MCP tools not Tasks). These have zero Agent Teams applicability at command level.",
    "CONSTRAINT-WC-05: brainstorm and refactor use Skill tool exclusively (not Task tool). Agent Teams requires Task-based agents, making these incompatible without architectural change.",
    "CONSTRAINT-WC-06: All existing parallel patterns are simple fork-join with no inter-agent dependency during execution. Agents do not need to coordinate, share context, or self-assign from task lists.",
    "CONSTRAINT-WC-07: TeammateIdle and TaskCompleted hooks exist in hooks.json but are skeleton implementations (logging only to ~/.claude/logs/hook-events/*.jsonl). No orchestration logic.",
    "CONSTRAINT-WC-08: /commit uses general-purpose subagent_type while TPD uses typed subagent_type (tpd:investigation:boundary-explorer etc.). Agent Teams requires named teammates.",
    "CONSTRAINT-WC-09: Each command must support both Task subagent mode (default) and Agent Teams mode (experimental). Zero behavior change when env var not set.",
    "CONSTRAINT-WC-10: allowed-tools in command frontmatter must include Task tool for any command using parallel agents. Commands using only Skill tool (brainstorm, refactor) cannot adopt Agent Teams without adding Task to allowed-tools."
  ],
  "open_questions": [
    "OQ-WC-01: Should the cross-model mailbox restriction in /tpd:dev Agent Teams section be relaxed? Current design forbids it, but Agent Teams' key value proposition is inter-agent messaging.",
    "OQ-WC-02: For /tpd:thinking, could boundary-explorer agents benefit from sharing discovered constraints with each other (e.g., agent exploring user-domain informs auth-session agent of relevant findings)?",
    "OQ-WC-03: For /tpd:plan, could codex-architect and gemini-architect benefit from coordinating to avoid conflicting architecture decisions instead of producing independent plans merged later?",
    "OQ-WC-04: Should TeammateIdle hooks evolve from logging-only to auto-assigning next tasks from a shared task list? This would be a significant orchestration change.",
    "OQ-WC-05: For /ui-design Phase 6, the 3 design variant generators are completely independent (variant A/B/C). Is there any scenario where they should coordinate?",
    "OQ-WC-06: Should /brainstorm or /refactor be refactored to use Task subagents (currently Skill-only) to enable future Agent Teams adoption?",
    "OQ-WC-07: What is the maximum team size supported by Agent Teams? /tpd:dev team cycle would have 4 agents (2 implementers + 2 auditors). Is this within limits?",
    "OQ-WC-08: How does Agent Teams handle the JUST RUN AND WAIT pattern vs run_in_background=true pattern? TPD uses the former, commit/ui-design uses the latter."
  ],
  "dependencies": [
    "Claude Code v2.1.33+ with Agent Teams support (CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1)",
    "Task tool for parallel agent execution (core Claude Code tool)",
    "Skill tool for atomic operations (core Claude Code tool)",
    "plugins/hooks/hooks/hooks.json - TeammateIdle and TaskCompleted hook entries",
    "plugins/hooks/scripts/orchestration/teammate-idle.sh - TeammateIdle handler (currently logging-only)",
    "plugins/hooks/scripts/orchestration/task-completed.sh - TaskCompleted handler (currently logging-only)",
    "Run directory convention (.claude/{plugin}/runs/{timestamp}/ or openspec/changes/{proposal_id}/{phase}/)",
    "state.json for workflow progress tracking in TPD workflows",
    "mcp__codex__codex and mcp__gemini__gemini for multi-model analysis (used in plan Step 4)",
    "mcp__auggie-mcp__codebase-retrieval for semantic code search",
    "codeagent-wrapper CLI for codex/gemini agent invocation within Task subagents"
  ],
  "risks": [
    "RISK-WC-01 (HIGH): Agent Teams is experimental (Research Preview). Workflows must maintain full backward compatibility with Task subagent mode when env var is not set.",
    "RISK-WC-02 (HIGH): Paradigm shift from file-based communication to inter-agent messaging. All 9 commands use file-based artifact exchange. Switching to Agent Teams messaging requires fundamental communication pattern change.",
    "RISK-WC-03 (MEDIUM): Cross-model isolation enforcement. Current design keeps codex and gemini on independent tracks. Agent Teams messaging could inadvertently break this isolation, allowing model outputs to leak into each other's context.",
    "RISK-WC-04 (MEDIUM): The JUST RUN AND WAIT pattern (synchronous Task execution) in TPD workflows may be incompatible with Agent Teams self-coordination model where agents self-assign from task lists.",
    "RISK-WC-05 (LOW): TeammateIdle/TaskCompleted hooks are logging-only. Enhancing them for real orchestration (auto-task-assignment, progress tracking) is non-trivial and could introduce race conditions.",
    "RISK-WC-06 (LOW): /brainstorm and /refactor are Skill-only workflows. Any Agent Teams integration would require adding Task to their allowed-tools, changing their execution model.",
    "RISK-WC-07 (MEDIUM): Agent Teams team size and coordination overhead. For small parallel tasks (2 agents), Agent Teams overhead may exceed the benefit of self-coordination vs simple fork-join."
  ],
  "success_criteria_hints": [
    "SC-WC-01: Every command must work identically with and without CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1 (backward compatibility)",
    "SC-WC-02: /tpd:dev Agent Teams section is the primary integration target; it already has the skeleton. Verify the team cycle (prototype -> audit -> fix) works end-to-end.",
    "SC-WC-03: Commands with no parallel agents (init, brainstorm, refactor, memory) should NOT have Agent Teams integration forced upon them.",
    "SC-WC-04: Classification of each command as Agent Teams candidate or Task-stays must be documented with rationale.",
    "SC-WC-05: TeammateIdle and TaskCompleted hooks should have at minimum logging + metrics; orchestration logic (auto-assignment) is optional/future.",
    "SC-WC-06: Cross-model isolation must be maintained even in Agent Teams mode unless explicitly relaxed by design decision.",
    "SC-WC-07: Agent Teams adoption should be opt-in per workflow, not a global switch affecting all plugins."
  ],
  "command_inventory": {
    "total_commands": 9,
    "total_plugins_with_commands": 6,
    "plugins_without_commands": ["hooks"],
    "commands": [
      {
        "file": "plugins/tpd/commands/thinking.md",
        "slash_command": "/tpd:thinking",
        "plugin": "tpd",
        "parallel_pattern": "fork-join",
        "max_parallel_agents": 4,
        "parallel_steps": [
          {
            "step": 2,
            "agents": 4,
            "types": ["tpd:investigation:boundary-explorer"],
            "mode": "synchronous (JUST RUN AND WAIT)"
          },
          {
            "step": 3,
            "agents": 2,
            "types": [
              "tpd:reasoning:codex-constraint",
              "tpd:reasoning:gemini-constraint"
            ],
            "mode": "synchronous (JUST RUN AND WAIT)"
          }
        ],
        "inter_agent_communication": "none (file-based: explore-*.json, codex-thought.md, gemini-thought.md)",
        "agent_dependency_during_execution": false,
        "agent_teams_recommendation": "NOT_RECOMMENDED",
        "agent_teams_rationale": "Boundary explorers explore different context boundaries independently. Constraint agents analyze from different perspectives independently. No coordination benefit. Simple fork-join is sufficient."
      },
      {
        "file": "plugins/tpd/commands/plan.md",
        "slash_command": "/tpd:plan",
        "plugin": "tpd",
        "parallel_pattern": "fork-join",
        "max_parallel_agents": 2,
        "parallel_steps": [
          {
            "step": 2,
            "agents": 2,
            "types": [
              "tpd:investigation:context-analyzer",
              "tpd:requirement-parser (Skill)"
            ],
            "mode": "mixed (Task + Skill)"
          },
          {
            "step": 3,
            "agents": 2,
            "types": [
              "tpd:planning:codex-architect",
              "tpd:planning:gemini-architect"
            ],
            "mode": "synchronous (JUST RUN AND WAIT)"
          }
        ],
        "inter_agent_communication": "none (file-based: codex-plan.md, gemini-plan.md)",
        "agent_dependency_during_execution": false,
        "agent_teams_recommendation": "MARGINAL",
        "agent_teams_rationale": "Codex and gemini architects could theoretically coordinate to avoid conflicting architecture decisions. However, the current merge-later approach works and divergence is a feature (provides multiple perspectives). Low benefit, medium complexity."
      },
      {
        "file": "plugins/tpd/commands/dev.md",
        "slash_command": "/tpd:dev",
        "plugin": "tpd",
        "parallel_pattern": "iterative-team-cycle (Agent Teams) or fork-join (default)",
        "max_parallel_agents": 4,
        "parallel_steps": [
          {
            "step": 2,
            "agents": 2,
            "types": [
              "tpd:context-retriever (Skill)",
              "tpd:execution:codex-implementer"
            ],
            "mode": "mixed"
          },
          {
            "step": 3,
            "agents": 2,
            "types": [
              "tpd:execution:codex-implementer",
              "tpd:execution:gemini-implementer"
            ],
            "mode": "synchronous (JUST RUN AND WAIT)"
          },
          {
            "step": 5,
            "agents": 2,
            "types": [
              "tpd:execution:codex-auditor",
              "tpd:execution:gemini-auditor"
            ],
            "mode": "synchronous (JUST RUN AND WAIT)"
          }
        ],
        "inter_agent_communication": "none in default mode; Agent Teams mode replaces Step 3+5 with team cycle (cross-model mailbox forbidden)",
        "agent_dependency_during_execution": true,
        "existing_agent_teams_section": "lines 351-387 - team cycle: prototype -> audit -> fix (max 2 iterations)",
        "agent_teams_recommendation": "STRONGEST_CANDIDATE",
        "agent_teams_rationale": "Already has Agent Teams skeleton. The iterative prototype->audit->fix cycle benefits from shared task list and coordination. Auditors finding issues can directly inform implementers. However, cross-model mailbox is currently forbidden - this is a design tension to resolve."
      },
      {
        "file": "plugins/tpd/commands/init.md",
        "slash_command": "/tpd:init",
        "plugin": "tpd",
        "parallel_pattern": "sequential",
        "max_parallel_agents": 0,
        "parallel_steps": [],
        "inter_agent_communication": "N/A",
        "agent_dependency_during_execution": false,
        "agent_teams_recommendation": "NOT_APPLICABLE",
        "agent_teams_rationale": "Initialization utility with no Task subagents. Sequential steps only (detect OS, install, initialize, validate)."
      },
      {
        "file": "plugins/commit/commands/commit.md",
        "slash_command": "/commit",
        "plugin": "commit",
        "parallel_pattern": "fork-join",
        "max_parallel_agents": 2,
        "parallel_steps": [
          {
            "step": "Phase 3",
            "agents": 2,
            "types": ["commit:semantic-analyzer", "commit:symbol-analyzer"],
            "mode": "background (run_in_background=true)"
          }
        ],
        "inter_agent_communication": "none (file-based: semantic-analysis.json, symbol-analysis.json -> merged by analysis-synthesizer Skill)",
        "agent_dependency_during_execution": false,
        "agent_teams_recommendation": "NOT_RECOMMENDED",
        "agent_teams_rationale": "Classic fork-join pattern. Semantic and symbol analyzers are completely independent, produce separate JSON files, merged by a synthesizer Skill. No inter-agent coordination needed. Agent Teams overhead exceeds benefit for 2 independent agents."
      },
      {
        "file": "plugins/ui-design/commands/ui-design.md",
        "slash_command": "/ui-design",
        "plugin": "ui-design",
        "parallel_pattern": "fork-join",
        "max_parallel_agents": 3,
        "parallel_steps": [
          {
            "step": "Phase 6",
            "agents": 3,
            "types": ["ui-design:design:design-variant-generator x3"],
            "mode": "background (run_in_background=true, TaskOutput to wait)"
          }
        ],
        "inter_agent_communication": "none (file-based: design-A.md, design-B.md, design-C.md)",
        "agent_dependency_during_execution": false,
        "agent_teams_recommendation": "NOT_RECOMMENDED",
        "agent_teams_rationale": "Three variant generators produce completely independent design documents. No coordination benefit. Phase 8 dual-model (Gemini->Claude) is sequential pipeline, not parallel. Agent Teams adds complexity without benefit."
      },
      {
        "file": "plugins/brainstorm/commands/brainstorm.md",
        "slash_command": "/brainstorm",
        "plugin": "brainstorm",
        "parallel_pattern": "sequential",
        "max_parallel_agents": 0,
        "parallel_steps": [],
        "inter_agent_communication": "N/A (Skill-only workflow)",
        "agent_dependency_during_execution": false,
        "agent_teams_recommendation": "NOT_APPLICABLE",
        "agent_teams_rationale": "Sequential Skill-only workflow. Multi-model parallelism exists inside idea-generator Skill but is not visible at command level. No Task subagents to convert to Agent Teams."
      },
      {
        "file": "plugins/refactor/commands/refactor.md",
        "slash_command": "/refactor",
        "plugin": "refactor",
        "parallel_pattern": "sequential",
        "max_parallel_agents": 0,
        "parallel_steps": [],
        "inter_agent_communication": "N/A (Skill-only workflow)",
        "agent_dependency_during_execution": false,
        "agent_teams_recommendation": "NOT_APPLICABLE",
        "agent_teams_rationale": "Sequential Skill-only workflow with strict phase dependencies (smell detection -> suggestion -> impact analysis -> execution). Each phase depends on previous output. No parallelism to exploit."
      },
      {
        "file": "plugins/context-memory/commands/memory.md",
        "slash_command": "/memory",
        "plugin": "context-memory",
        "parallel_pattern": "sequential-router",
        "max_parallel_agents": 0,
        "parallel_steps": [],
        "inter_agent_communication": "N/A (Skill router)",
        "agent_dependency_during_execution": false,
        "agent_teams_recommendation": "NOT_APPLICABLE",
        "agent_teams_rationale": "Command router that dispatches to individual Skill calls. claude-full uses sequential loop (Layer 3->2->1). No Task subagents, no parallelism at command level."
      }
    ]
  },
  "agent_teams_summary": {
    "strongest_candidate": "/tpd:dev - Already has Agent Teams skeleton. Iterative prototype->audit->fix cycle benefits from coordination.",
    "marginal_candidates": [
      "/tpd:plan - Architects could coordinate, but independent perspectives are a feature."
    ],
    "not_recommended": [
      "/tpd:thinking - Independent boundary exploration, fork-join sufficient.",
      "/commit - Simple 2-agent fork-join, no coordination needed.",
      "/ui-design - Independent variant generation, fork-join sufficient."
    ],
    "not_applicable": [
      "/tpd:init - No agents.",
      "/brainstorm - Skill-only.",
      "/refactor - Skill-only sequential.",
      "/memory - Skill router."
    ],
    "key_insight": "Only /tpd:dev has inter-step agent dependency (audit depends on prototype, fixes feed back to prototype). All other parallel workflows are pure fork-join with no inter-agent coordination during execution. Agent Teams provides the most value where agents need to iterate, share context, or self-assign from task lists - which only applies to the dev workflow's prototype->audit->fix cycle."
  },
  "hooks_integration_status": {
    "teammate_idle_hook": {
      "file": "plugins/hooks/scripts/orchestration/teammate-idle.sh",
      "registered_in": "plugins/hooks/hooks/hooks.json (TeammateIdle event)",
      "current_status": "logging-only (writes to ~/.claude/logs/hook-events/teammate-idle.jsonl)",
      "fields_captured": ["timestamp", "teammate", "idle_since", "raw input"]
    },
    "task_completed_hook": {
      "file": "plugins/hooks/scripts/orchestration/task-completed.sh",
      "registered_in": "plugins/hooks/hooks/hooks.json (TaskCompleted event)",
      "current_status": "logging-only (writes to ~/.claude/logs/hook-events/task-completed.jsonl)",
      "fields_captured": ["timestamp", "task_id", "status", "raw input"]
    }
  }
}
