{
  "module_name": "hook-system",
  "existing_structures": [
    "plugins/hooks/hooks/hooks.json - Master hook registry with 5 lifecycle event types as top-level keys",
    "hooks.json schema: { description, hooks: { EventName: [ { matcher: regex, hooks: [{ type, command, timeout?, async? }] } ] } }",
    "5 current lifecycle events: UserPromptSubmit, PreToolUse, PostToolUse, PermissionRequest, Notification",
    "12 hook scripts across 6 categories: security(3), optimization(1), quality(1), logging(2), permission(2), evaluation(1), notification(1)",
    "scripts/security/privacy-firewall.sh - UserPromptSubmit, matcher '*', timeout 3s, blocks sensitive data in prompts",
    "scripts/security/db-guard.sh - PreToolUse, matcher 'Bash', timeout 3s, blocks destructive SQL",
    "scripts/security/git-conflict-guard.sh - PreToolUse, matcher 'Bash', timeout 5s, blocks commits with conflict markers",
    "scripts/security/killshell-guard.sh - PreToolUse, matcher 'KillShell', timeout 5s, protects codeagent-wrapper processes",
    "scripts/optimization/read-limit.sh - PreToolUse, matcher 'Read', timeout 5s, auto-injects limit for large files",
    "scripts/quality/auto-format.sh - PostToolUse, matcher 'Write|Edit|MultiEdit', timeout 30s, runs Prettier/Black/gofmt/rustfmt",
    "scripts/logging/auto-backup.sh - PreToolUse, matcher 'Write', timeout 10s, async:true, timestamped backups",
    "scripts/logging/mcp-logger.sh - PreToolUse, matcher 'mcp__.*', timeout 5s, async:true, logs MCP calls",
    "scripts/permission/auto-approve.sh - PermissionRequest, matcher 'Bash', timeout 3s, auto-approves safe read-only commands",
    "scripts/permission/file-permission.sh - PermissionRequest, matcher 'Write|Edit', timeout 3s, manages file write permissions",
    "scripts/evaluation/unified-eval.sh - UserPromptSubmit, matcher '*', timeout 10s, smart plugin router + intent evaluation",
    "scripts/notification/smart-notify.sh - Notification, matcher '*', timeout 5s, multi-channel notification dispatch (desktop/Bark/ntfy/Telegram/Slack/Discord)",
    "plugins/hooks/.claude-plugin/plugin.json - Plugin identity (name:'hooks', version:'1.0.0')",
    "ui-design plugin uses alternate hook format: { hooks: [{ event, type:'bash', command, description }] } in .claude-plugin/hooks.json"
  ],
  "existing_conventions": [
    "All hook scripts use bash with 'set -euo pipefail' shebang pattern",
    "JSON input read via stdin: input=$(cat), parsed with jq",
    "Logging to stderr with colored prefixes: log_info (green), log_warn (yellow), log_error (red), log_debug (blue)",
    "JSON output to stdout for hook responses; exit 0 with no output = pass-through",
    "Script header block with purpose, trigger event, priority level, and version comments",
    "Script paths use ${CLAUDE_PLUGIN_ROOT} variable for portability",
    "Matcher patterns are regex strings: exact ('Read', 'Bash', 'KillShell'), union ('Write|Edit|MultiEdit'), prefix-regex ('mcp__.*'), wildcard ('*')",
    "Timeout range: 3s (security guards) to 30s (auto-format); typical 3-10s",
    "async:true for non-blocking hooks (backup, logging) that should not delay tool execution",
    "Output JSON types: block={decision:'block',reason:...}, modify={hookSpecificOutput:{updatedInput:...,additionalContext:...}}, permission={hookSpecificOutput:{decision:{behavior:'allow'}}}, deny={hookSpecificOutput:{permissionDecision:'deny',permissionDecisionReason:...}}, pass={exit 0}",
    "Scripts handle missing fields gracefully with jq '// empty' fallback pattern",
    "Notification hook extracts session_id, cwd, hook_event_name from input JSON",
    "Scripts organized in subdirectories by category: security/, optimization/, quality/, logging/, permission/, evaluation/, notification/"
  ],
  "constraints_discovered": [
    "HC-1: hooks.json auto-loaded by Claude Code v2.1+ - MUST NOT declare hooks in plugin.json (causes duplicate detection error, tracked as recurring regression in issues #29, #52, #103)",
    "HC-2: TeammateIdle and TaskCompleted are NEW event types in Claude Code v2.1.32-33, not present in any existing hooks.json - no existing scripts handle them",
    "HC-3: New event types must follow the same top-level key pattern in hooks.json: 'TeammateIdle': [...] and 'TaskCompleted': [...]",
    "HC-4: Input JSON schema for TeammateIdle/TaskCompleted will differ from tool-based events - no tool_name/tool_input fields, instead teammate/task metadata",
    "HC-5: Current 5 events are tool-centric (pre/post tool use, permission, prompt, notification); TeammateIdle/TaskCompleted are agent-centric - a category shift",
    "HC-6: Matcher semantics unclear for agent-centric events - may need '*' wildcard or agent-name matchers instead of tool-name matchers",
    "SC-1: Existing smart-notify.sh already handles Notification events and could be extended/reused for TaskCompleted notifications",
    "SC-2: New scripts should follow the existing bash+jq pattern for consistency with the 12 existing scripts",
    "SC-3: A new script subdirectory 'orchestration/' would be needed for agent-lifecycle hooks (no existing category fits)",
    "SC-4: Prior exploration (understand-everything-claude-code) noted 7 hook event types in Claude Code core including PreCompact, SessionStart, SessionEnd, Stop - the ccg-workflows hooks.json only uses 5 of these",
    "SC-5: The input.md classifies hooks integration as P1 priority with 'small effort' assessment"
  ],
  "open_questions": [
    "OQ-1: What is the exact input JSON schema for TeammateIdle events? Does it include teammate_name, teammate_agent, last_task, idle_duration, session context?",
    "OQ-2: What is the exact input JSON schema for TaskCompleted events? Does it include task_id, agent_name, result_summary, duration, exit_status?",
    "OQ-3: Do TeammateIdle/TaskCompleted support the same matcher mechanism as tool-based events, or do they use a different matching pattern (e.g., agent name instead of tool name)?",
    "OQ-4: Can TeammateIdle hooks output a response that reassigns work to the idle teammate, or is it purely observational (fire-and-forget)?",
    "OQ-5: Can TaskCompleted hooks modify the completion result or inject follow-up actions, or is it purely for logging/notification?",
    "OQ-6: Should TeammateIdle trigger the existing smart-notify.sh for desktop/mobile alerts, or does it need a dedicated orchestration script?",
    "OQ-7: Does the CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1 flag need to be checked by hook scripts, or does Claude Code simply not fire these events when teams are disabled?",
    "OQ-8: Are there Claude Code v2.1.32-33 changelog entries or documentation that specify the exact hook event contract for these new events?",
    "OQ-9: Should the hooks plugin support TaskCompleted for both Agent Teams tasks and regular Task tool completions, or only teams?"
  ],
  "dependencies": [
    "Claude Code CLI v2.1.32+ - Minimum version for TeammateIdle hook event support",
    "Claude Code CLI v2.1.33+ - Minimum version for TaskCompleted hook event support (verify exact version)",
    "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1 - Required environment variable for Agent Teams feature",
    "jq - Required by all existing hook scripts for JSON parsing",
    "bash 3.x+ - All scripts use bash-compatible syntax (macOS ships 3.x)",
    "${CLAUDE_PLUGIN_ROOT} - Environment variable set by Claude Code for portable script paths",
    "Existing smart-notify.sh infrastructure - Multi-channel notification dispatch (potential reuse for TaskCompleted)",
    "Existing unified-eval.sh infrastructure - Plugin catalog collection (potential extension for agent-aware routing)",
    "Optional: BARK_KEY, NTFY_TOPIC, TELEGRAM_BOT_TOKEN, SLACK_WEBHOOK_URL, DISCORD_WEBHOOK_URL - Notification channel credentials"
  ],
  "risks": [
    "R-1 (Medium): Input JSON schema uncertainty - TeammateIdle/TaskCompleted input schemas are not documented in the codebase; scripts must be defensive about field presence",
    "R-2 (Low): Matcher pattern mismatch - If agent-centric events use different matcher semantics than tool-centric events, wildcard '*' may not work as expected",
    "R-3 (Low): Backward compatibility - Adding new top-level keys to hooks.json should be safe since Claude Code ignores unknown event types in older versions",
    "R-4 (Medium): Experimental feature stability - Agent Teams requires CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1; the hook events may change in future versions",
    "R-5 (Low): Hook duplicate detection regression - Must only add events to hooks/hooks.json, never to plugin.json (recurring issue #29, #52, #103)",
    "R-6 (Low): Timeout tuning - Agent orchestration hooks may need longer timeouts if they perform work reassignment, but existing convention caps at 30s",
    "R-7 (Low): Category creep - Adding 'orchestration' as a 7th script category increases organizational complexity"
  ],
  "success_criteria_hints": [
    "hooks.json gains two new top-level event keys: 'TeammateIdle' and 'TaskCompleted' with proper matcher/hooks arrays",
    "At least one new script per event type in a new 'scripts/orchestration/' subdirectory",
    "New scripts follow existing bash+jq pattern: stdin JSON input, stderr logging, stdout JSON output, exit 0 pass-through",
    "TeammateIdle script logs idle event and optionally triggers notification channels via smart-notify pattern reuse",
    "TaskCompleted script logs completion metadata and dispatches notifications for workflow milestone tracking",
    "No modification to plugin.json (hooks auto-loaded from hooks/hooks.json only)",
    "All new scripts handle missing/unexpected input fields gracefully with jq '// empty' fallback",
    "Timeout values set appropriately (5-10s range for orchestration hooks)",
    "Existing 12 hook scripts remain unchanged - zero regression on current functionality",
    "Documentation in llmdoc/architecture/hooks-system.md and llmdoc/reference/hook-scripts.md updated to reflect 7 lifecycle events"
  ]
}
