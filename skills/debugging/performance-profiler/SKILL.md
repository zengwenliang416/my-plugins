---
name: performance-profiler
description: |
  【触发条件】当需要分析性能瓶颈、内存泄漏、CPU 占用、响应时间优化时使用。
  【触发关键词】性能分析、profiling、内存泄漏、CPU 占用、慢查询、响应慢、优化性能、benchmark
  【核心能力】识别瓶颈 → 收集指标 → 分析热点 → 生成优化建议
  【不触发】功能开发、Bug 修复（非性能相关）、代码审查
  【先问什么】若缺少：性能问题表现、技术栈、可接受的响应时间，先提问补齐
---

# Performance Profiler

应用性能分析与优化指南。

## 工作流程

```
1. 问题定位 → 2. 指标收集 → 3. 热点分析 → 4. 优化建议 → 5. 验证效果
```

---

## 性能问题分类

| 类型     | 表现               | 常见原因                           |
| -------- | ------------------ | ---------------------------------- |
| CPU 密集 | CPU 占用高、响应慢 | 复杂计算、死循环、低效算法         |
| 内存泄漏 | 内存持续增长、OOM  | 未释放引用、闭包陷阱、缓存无限增长 |
| I/O 阻塞 | 等待时间长、吞吐低 | 同步 I/O、数据库慢查询、网络延迟   |
| 并发问题 | 死锁、资源争用     | 锁竞争、线程池配置不当             |

---

## 快速分析

```bash
# 系统概览
./scripts/quick-profile.sh system

# Node.js 分析
./scripts/quick-profile.sh node app.js

# Python 分析
./scripts/quick-profile.sh python script.py

# HTTP 压测
./scripts/quick-profile.sh http http://localhost:3000/
```

---

## 关键指标

| 指标         | 正常范围 | 告警阈值 |
| ------------ | -------- | -------- |
| CPU 使用率   | < 70%    | > 85%    |
| 内存使用率   | < 80%    | > 90%    |
| 响应时间 P99 | < 200ms  | > 500ms  |
| GC 暂停时间  | < 50ms   | > 100ms  |

---

## 火焰图解读

```
宽度 = 时间占比（越宽越耗时）
高度 = 调用栈深度

优化目标：找到最宽的"平顶"函数 → 分析调用路径 → 优化或缓存
```

---

## 通用优化策略

| 问题类型 | 优化策略                                |
| -------- | --------------------------------------- |
| 计算密集 | 算法优化、缓存结果、Worker 线程         |
| 内存泄漏 | 清理引用、WeakMap/WeakRef、限制缓存大小 |
| I/O 阻塞 | 异步化、批量操作、连接池                |
| 数据库慢 | 索引优化、查询重写、读写分离            |

---

## 报告模板

```markdown
## 性能分析报告

### 问题描述

[具体表现和影响范围]

### 环境信息

- 技术栈: Node.js 18 / React 18
- 部署环境: AWS EC2 t3.medium
- 并发量: ~100 QPS

### 热点分析

| 热点函数    | 耗时占比 | 调用次数 |
| ----------- | -------- | -------- |
| processData | 45%      | 10000    |

### 优化建议

1. [建议1] - 预期提升 X%
2. [建议2] - 预期提升 Y%

### 验证方法

[如何验证优化效果]
```

---

## 工具脚本

| 脚本                       | 功能         | 用法                                         |
| -------------------------- | ------------ | -------------------------------------------- |
| `scripts/quick-profile.sh` | 快速性能分析 | `./scripts/quick-profile.sh [type] [target]` |

---

## 参考文档导航

| 需要         | 读取                                  |
| ------------ | ------------------------------------- |
| 分析工具详解 | `references/profiling-tools.md`       |
| 优化模式示例 | `references/optimization-patterns.md` |
